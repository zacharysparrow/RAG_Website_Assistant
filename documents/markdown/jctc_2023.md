      ## High-Throughput Condensed-Phase Hybrid Density Functional Theory for Large-Scale Finite-Gap Systems: The SeA Approach

Hsin-Yu Ko, Marcos F. Calegari Andrade, Zachary M. Sparrow, Ju-an Zhang, and Robert A. DiStasio, Jr.\*

Cite This: J. Chem. Theory Comput. 2023, 19, 4182–4201

## ABSTRACT:
 High-throughput electronic structure calculations (often performed using density functional theory (DFT)) play a central role in screening existing and novel materials, sampling potential energy surfaces, and generating data for machine learning applications. By including a fraction of exact exchange (EXX), hybrid functionals reduce the self-interaction error in semilocal DFT and furnish a more accurate description of the underlying electronic structure, albeit at a computational cost that often prohibits such high-throughput applications. To address this challenge, we have constructed a robust, accurate, and computationally efficient framework for high-throughput condensed-phase hybrid DFT and implemented this approach in the PWSCF module of Quantum ESPRESSO (QE). The resulting SeA approach (SeA = SCDM + exx + ACE) combines and seamlessly integrates: (i) the selected columns of the density matrix method (SCDM, a robust noniterative orbital localization scheme that sidesteps system-dependent optimization protocols), (*ii*) a recently extended version of  $\in xx$  (a black-box linear-scaling EXX algorithm that exploits sparsity between localized orbitals in real space when evaluating the action of the standard/full-rank  $\hat{V}_{xx}$  operator), and (*iii*) adaptively compressed exchange (ACE, a low-rank  $\hat{V}_{xx}$  approximation). In doing so, SeA harnesses three levels of computational savings: *pair selection* and *domain truncation* from SCDM +  $\in xx$  (which only considers spatially overlapping orbitals on orbital-pair-specific and system-size-independent domains) and *low-rank*  $\hat{V}_{xx}$  approximation from ACE (which reduces the number of calls to SCDM + exx during the self-consistent field (SCF) procedure). Across a diverse set of 200 nonequilibrium (H<sub>2</sub>O)<sub>64</sub> configurations (with densities spanning 0.4–1.7 g/cm<sup>3</sup>), SeA provides a 1–2 order-of-magnitude speedup in the overall time-to-solution, i.e.,  $\approx 8-26\times$  compared to the convolution-based PWSCF (ACE) implementation in QE and  $\approx 78-247\times$  compared to the conventional PWSCF (Full) approach, and yields energies, ionic forces, and other properties with high fidelity. As a proof-of-principle high-throughput application, we trained a deep neural network (DNN) potential for ambient liquid water at the hybrid DFT level using SeA via an actively learned data set with  $\approx 8,700$  (H<sub>2</sub>O)<sub>64</sub> configurations. Using an out-of-sample set of (H<sub>2</sub>O)<sub>512</sub> configurations (at nonambient conditions), we confirmed the accuracy of this SeA-trained potential and showcased the capabilities of SeA by computing the ground-truth ionic forces in this challenging system containing >1,500 atoms.

Image /page/0/Figure/10 description: The image is a diagram titled "Article Recommendations". At the top of the diagram is a box containing the text "SCDM + exx + ACE" and "SeA". Below this box is an oval containing the text "High-Throughput Hybrid DFT". Three arrows point from the oval to three boxes below. The first box is labeled "Materials Screening" and contains two images of molecular structures. The second box is labeled "PES Sampling" and contains a graph. The third box is labeled "Data Generation" and contains the equations "R(1) -> E(1), F(1)", "R(2) -> E(2), F(2)", and "R(n) -> E(n), F(n)". To the right of the oval is a gauge labeled "Time-to-Solution". The gauge ranges from 1 to 1000, with 10 and 100 also marked. The gauge is divided into three sections: "SeA", "Hybrid", and "Full". The needle on the gauge points to the "Hybrid" section. The gauge also contains the text "GGA".

## I. INTRODUCTION

High-throughput *ab initio* electronic structure calculations play a key role in the computational screening and design of novel materials,<sup>1,2</sup> exploring and sampling potential energy surfaces (PES), as well as generating quantum mechanical data needed for machine learning (ML) applications.<sup>3–5</sup> Since the accuracy is largely governed by the underlying electronic structure method, it is crucial to perform such high-throughput calculations at an appropriate level of theory. Among the available *ab initio* electronic structure methods, Kohn–Sham (KS) density functional theory (DFT)<sup>6,7</sup> has emerged as the computational workhorse for simulating large molecules and complex condensed-phase systems. Despite being exact in theory, the exchange–correlation (xc) functional encoding the nontrivial many-body interactions between electrons remains unknown to date; hence, the accuracy of DFT calculations in practice largely relies on functional approximations.<sup>8–16</sup> For condensed-phase systems, the xc functional is predominantly computed within the (semilocal) generalized gradient approximation (GGA), which includes a local dependence on the electron density,  $\rho(r)$ , and its gradient,  $\nabla \rho(r)$ . To reduce the deleterious self-interaction error (SIE)<sup>17,18</sup> at the GGA level (in which each electron spuriously interacts with itself), hybrid functionals<sup>19</sup> include a fraction of exact exchange (EXX) in the xc contribution to the DFT energy. In doing so, hybrid functionals tend to furnish a more accurate description of the underlying electronic structure, albeit at a high computational cost that often limits their use in high-throughput applications (particularly for large-scale condensed-phase systems).

Since the cost of performing condensed-phase hybrid DFT calculations using the conventional convolution-based EXX algorithm<sup>20</sup> often significantly exceeds that of GGA-based KS-DFT, methods for efficiently performing such challenging calculations are key to the routine use of hybrid functionals in high-throughput applications and have therefore received considerable attention from the community.<sup>21-49</sup> For largescale condensed-phase systems with finite gaps, a numerically accurate evaluation of the EXX energy  $(E_{xx})$  can be accomplished with linear-scaling cost using exx, 47,49 a realspace algorithm that exploits the sparsity in the exchange interaction provided by a localized representation of the occupied orbitals (e.g., maximally localized Wannier functions, MLWFs<sup>50,51</sup>). To facilitate a linear-scaling (or order-N) evaluation of  $E_{xx}$  (as well as other important EXX-related quantities, vide infra), the exx algorithm exploits the following two levels of sparsity (for more details, see section II.B and refs 47 and 49): (i) pair selection—exx only considers spatially overlapping orbital pairs that will have a nonvanishing EXX interaction; and (ii) domain truncation—exx only evaluates the corresponding EXX interactions on orbital-pair-specific and system-size-independent spatial domains (instead of the entire real-space mesh). With a massively parallel hybrid MPI/ OpenMP implementation in the CP module of the opensource Quantum ESPRESSO (QE) package<sup>52</sup> in conjunction with on-the-fly MLWF localization, <sup>53</sup> exx has enabled hybrid DFT-based ab initio molecular dynamics (AIMD) of largescale condensed-phase systems containing 500-1000 atoms in the microcanonical/canonical (NVE/NVT) and isobaricisoenthalpic/isobaric-isothermal (NpH/NpT) ensembles with a wall time cost that is comparable to GGA-based KS-DFT.<sup>47,49</sup> In doing so, current (and pilot) implementations of exx have been used to conduct several challenging theoretical investigations at the hybrid DFT level regarding the electronic structure of semiconducting solids, 54,55 the structure and local order of ambient liquid water,<sup>33,56</sup> the structural and dynamical properties of aqueous ionic solutions,<sup>57,58</sup> the thermal properties of the pyridine-I molecular crystal,<sup>59</sup> as well as isotope effects on the structure of liquid water.60

While the current implementation of  $\exp^{47,49}$  was designed for large-scale AIMD simulations (particularly the Car– Parrinello<sup>61</sup> or CPMD variant), the computational efficiency of the core  $\exp$  algorithm also makes it well-suited for accurately and rapidly evaluating the action of the EXX operator ( $\hat{V}_{xx}$ ) on the (proto-)KS orbitals ({ $\phi_i$ }) during highthroughput self-consistent field (SCF) calculations at the hybrid DFT level (i.e., { $\hat{V}_{xx} \phi_i$ }, which is equivalent (to within a sign) to the EXX contribution to the wave function forces needed to propagate the CPMD equations of motion; see section II.B). However, direct use of this version of  $\exp$  would not meet the *implicit* robustness requirements of a highthroughput framework (i.e., black-box and automatable algorithms), since this implementation contains systemdependent parameters in: (*i*) the optimization protocol used to iteratively obtain the MLWFs needed by exx (e.g., initial guesses, convergence criteria, and choice of optimization algorithm); and (ii) the pair-selection and domain-truncation protocols used inside  $exx^{47,49}$  to harness the aforementioned two levels of computational savings (i.e., the pair distance cutoff, Poisson equation radii, and multipole expansion radii). In addition to these robustness requirements, there is potentially a third level of computational savings that could be harnessed to increase the efficiency of high-throughput SCF calculations at the hybrid DFT level. As pointed out by Lin,<sup>36</sup> these savings result from replacing unnecessary evaluations of  $\{\hat{V}_{xx} \phi_i\}$  using the standard/full-rank EXX operator—the typical bottleneck during SCF calculations at the hybrid DFT level-with more computationally efficient evaluations using a low-rank approximation for  $\hat{V}_{xx}$  (i.e., the adaptively compressed exchange (ACE) operator).

In this work, we directly address these issues by combining and seamlessly integrating three theoretical and algorithmic advances into a robust, accurate, and computationally efficient framework for performing high-throughput condensed-phase hybrid DFT calculations on large-scale finite-gap systems. As depicted in Figure 1, the resulting SeA framework (SeA = SCDM + exx + ACE) includes the selected columns of the density matrix (SCDM) orbital localization scheme of Damle, Lin, and Ying;<sup>35</sup> a recent black-box extension<sup>62</sup> of our linear-scaling exx algorithm;<sup>47,49</sup> and the ACE formalism of Lin.<sup>36</sup> For an accurate and efficient evaluation of the action using the standard/full-rank EXX operator—the typical bottleneck during SCF calculations at the hybrid DFT level—SeA employs the noniterative SCDM procedure for localized orbital <span id="page-2-0"></span><span id="page-2-0"></span>generation (thereby eliminating the need for system-dependent optimization protocols) in conjunction with a recently extended black-box version<sup>62</sup> of exx that replaces all systemdependent parameters with a single system-independent orbital coverage threshold. As described in ref 62, this version of exxis quite robust and able to treat both homogeneous and heterogeneous (i.e., multiphase and/or multicomponent) systems with controllable accuracy (i.e., with an *a priori* estimated error) and markedly improved computational efficiency. Hence, the combined use of SCDM with this version of exx (SCDM + exx) forms an effectively black-box EXX engine that harnesses two levels of computational savings (i.e., pair selection and domain truncation) when evaluating the most computationally demanding step in hybrid DFT (i.e., evaluation of  $\{V_{xx} \phi_i\}$ ). To further improve the overall efficiency, SeA harnesses a third level of computational savings by employing the ACE formalism to reduce the number of  $\{\hat{V}_{xx}, \phi_i\}$  evaluations during the iterative SCF procedure. In doing so, SeA not only reduces the number of calls to the most computational demanding step in hybrid DFT calculations (via ACE), but also drastically reduces the cost of evaluating each of the remaining calls (via SCDM + exx). The development of SeA was inspired by the following pioneering works that improved the efficiency of hybrid DFT by harnessing either one or two levels of computational savings based on orbital locality: Gygi and co-workers (who used pair selection<sup>32,34</sup> via recursive subspace bisection (RSB)<sup>27</sup>), Giannozzi and co-workers (who used pair selection in conjunction with ACE to form the localized ACE (L-ACE) method<sup>43</sup>), and Nair and co-workers (who used pair selection<sup>44</sup> in conjunction with the ACE operator and multiple time scale approach63 for efficient hybrid DFT based AIMD<sup>45,48</sup>). SeA differs from these previous developments by providing a single framework that harnesses three levels of savings (pair selection, domain truncation, and ACE) to further enable the routine use of hybrid DFT in highthroughput applications involving large-scale condensed-phase systems.

Image /page/1/Figure/8 description: The image is a diagram illustrating the SeA (Scalable Exact Exchange Algorithm) approach for high-throughput hybrid DFT (Density Functional Theory) calculations. The diagram is divided into three main sections: SCDM (Self-Consistent Density Matrix), exx (Exact Exchange), and ACE (Auxiliary Coulomb Engine). SCDM is described as a robust and non-iterative orbital localization scheme. Exx is described as a linear-scaling black-box EXX algorithm for finite-gap systems. ACE is described as a low-rank Vxx approximation to reduce SCDM+exx calls. The diagram also shows that the first two levels of computational savings are achieved through SCDM and exx, while the additional third level is achieved through ACE. The diagram then shows that the high-throughput hybrid DFT approach can be used for materials screening, PES (Potential Energy Surface) sampling, and data generation. The data generation section shows a list of R and F values with superscripts (1), (2), and (n).

**Figure 1.** Schematic illustration of the SeA approach, which seamlessly integrates three theoretical and algorithmic advances (the noniterative selected columns of the density matrix (SCDM) orbital localization scheme,<sup>35</sup> the linear-scaling exx algorithm,<sup>47,49,62</sup> and the adaptively compressed exchange (ACE) formalism<sup>36</sup>) into a robust, accurate, and computationally efficient framework for performing high-throughput condensed-phase hybrid DFT calculations on large-scale finite-gap systems. By harnessing three levels of computational savings, SeA paves the way toward the routine use of hybrid DFT in high-throughput applications such as materials screening and discovery, potential energy surface (PES) sampling, and data generation for machine learning (ML).

The remainder of this article is organized as follows. In section II, we provide a brief review of the SCDM, exx, and ACE approaches as well as their seamless combination/ integration into the SeA framework implemented in the PWSCF module of QE. In section III, we assess the accuracy and performance of SeA on a diverse set of 200 nonequilibrium  $(H_2O)_{64}$  configurations (which include both intact and autoionized water molecules, with system densities spanning 0.4–1.7 g/cm<sup>3</sup>) and demonstrate that SeA yields a 1-2 order-of-magnitude ( $\approx$ 11-116×) speedup in the computational bottleneck in the convolution-based PWSCF-(ACE) implementation in QE, while providing energies, ionic forces, and other properties with high fidelity. In doing so, SEA enables the routine use of hybrid DFT in highthroughput applications for systems with sizes similar to (and beyond)  $(H_2O)_{64}$ , and delivers single-point energy and ionic force evaluations for such systems with an  $\approx\!\!8{-}26{\times}$ speedup in the overall time-to-solution compared to PWSCF-(ACE) and an  $\approx 78-247 \times$  speedup compared to the conventional (non-ACE) PWSCF (Full) EXX implementation in QE. As a proof-of-principle high-throughput application, we used SEA in section IV to train a deep neural network (DNN) potential for ambient (T = 300 K, p = 1 bar) liquid water at the PBE0<sup>64,65</sup> level based on an actively learned data set containing  $\approx 8,700$  (H<sub>2</sub>O)<sub>64</sub> configurations. We then assessed the accuracy of this DNN potential on an out-ofsample test set ((H<sub>2</sub>O)<sub>512</sub> at T = 330 K and p = 1 bar) and showcased the capabilities of SeA by directly computing the (ground-truth) ionic forces in these challenging condensedphase systems containing >1,500 atoms. This article then concludes with a brief summary of our findings in section V and some potential future research directions in section VI.

## **II. THEORY**

In this section, we begin with a brief review of the noniterative SCDM orbital localization scheme,35 which will be used to generate localized occupied orbitals without the need for system-dependent optimization protocols (section II.A). Based on the set of localized orbitals computed with this scheme, we then describe a recent extension<sup>62°</sup> to the linear-scaling  $\in XX$ algorithm<sup>47,49</sup> that replaces all system-dependent parameters with a single system-independent orbital coverage threshold (section II.B); this algorithm harnesses two levels of computational savings (i.e., pair selection and domain truncation) and will be used to provide an accurate and efficient black-box evaluation of the action using the standard/ full-rank EXX operator  $(\hat{V}_{xx})$ . We then briefly summarize the ACE method, which provides a third level of computational savings by furnishing an efficient low-rank approximation to  $\hat{V}_{rec}$ that eliminates unnecessary full-rank evaluations of the action during the iterative SCF procedure (section II.C). This is followed by a detailed description of how these three theoretical and algorithmic advances are combined and seamlessly integrated into SeA (SCDM + exx + ACE)-a robust, accurate, and computationally efficient framework for high-throughput condensed-phase hybrid DFT for large-scale finite-gap systems (section II.D).

### II.A. SCDM: A Robust and Noniterative Orbital Localization Scheme. 
To generate the localized orbitals needed for exx, SeA employs the selected columns of the density matrix (SCDM) approach,<sup>35</sup> a robust and noniterative alternative to the well-known MLWF procedure  $^{50,51}$  used throughout the development of  $\exp^{26,33,47,49}$  Since this work focuses on EXX calculations involving large-scale finite-gap systems, we will center our discussion around the  $\Gamma$ -point specific SCDM algorithm.<sup>35</sup> However, this choice is not an intrinsic limitation of SeA, as exx could (in principle) utilize localized orbitals obtained via Brillouin zone sampling of the canonical KS orbitals with the SCDM-k approach.<sup>66</sup> The theoretical foundation underlying SCDM is the "nearsightedness" principle popularized by Kohn,67,68 which states that the elements of the real-space one-particle density matrix (P), i.e.,  $P(\mathbf{r}, \mathbf{r}') = \langle \mathbf{r} | \hat{P} | \mathbf{r}' \rangle = \sum_{i}^{N_{occ}} \langle \mathbf{r} | \phi_i \rangle \langle \phi_i | \mathbf{r}' \rangle$ , are exponentially decaying with respect to |r - r'| in finite-gap systems. On a real-space mesh with  $N_{\text{grid}}$  points,  $P = \Phi \Phi^T$  is an  $N_{\text{grid}} \times N_{\text{grid}}$ matrix constructed from  $\Phi$ , the corresponding  $N_{\rm grid} \times N_{\rm occ}$ wave function matrix with columns given by a set of  $N_{\rm occ}$ orbitals  $(\{\phi_i\})$  which spans the occupied space, e.g., the set of canonical KS occupied orbitals. As such, P is rank-deficient with a column space dimension of  $Rank(P) = N_{occ}$ , from which one can obtain a localized representation of the occupied space by selecting (and orthogonalizing) a set of  $N_{\rm occ}$  well-conditioned columns of P.

In the SCDM approach, this set of columns is obtained from a column-pivoted QR factorization of the  $N_{occ} \times N_{grid} \Phi^T$ matrix (instead of the significantly larger **P** matrix), as this <span id="page-3-0"></span><span id="page-3-0"></span>alternative formulation yields equivalent column selection at significantly lower computational cost.<sup>35</sup> Performing this factorization yields

$$\Phi^T \Pi = QR \tag{1}$$

in which  $\Pi$  is the  $N_{\rm grid} \times N_{\rm grid}$  permutation matrix (i.e., a dense representation of the selected column indices), Q is an  $N_{\rm occ} \times N_{\rm occ}$  orthogonal matrix, and R is an  $N_{\rm occ} \times N_{\rm grid}$  upper triangular matrix. The proto-SCDM orbitals (i.e., a well-conditioned set of localized but nonorthogonal orbitals that spans the occupied space) are then given by the following  $N_{\rm grid} \times N_{\rm occ}$  matrix:

$$\mathbf{X} \equiv \mathbf{P}_{:,C} = \mathbf{\Phi}(\mathbf{\Phi}^T)_{:,C} \tag{2}$$

in which ":" denotes all row indices, *C* is the set of indices corresponding to the  $N_{occ}$  selected columns, and  $(\mathbf{\Phi}^T)_{:,C}$  is an  $N_{occ} \times N_{occ}$  matrix containing the first  $N_{occ}$  columns of  $\mathbf{\Phi}^T \mathbf{\Pi}$ . The final SCDM orbitals are then obtained via symmetric orthogonalization of the proto-SCDM orbitals, namely

$$\tilde{\boldsymbol{\Phi}} = \boldsymbol{X}(\boldsymbol{P}_{C,C})^{-1/2} \tag{3}$$

in which  $P_{C,C} = X^T X$  is the  $N_{occ} \times N_{occ}$  overlap matrix in the proto-SCDM basis (which is also equivalent to the density matrix in the basis selected by C). In this expression, we follow the convention used during the development of  $\oplus xx$ :<sup>47,49</sup> all quantities that depend on the choice of localized orbitals (i.e., MLWFs in previous work and SCDM in this work) are dressed with tildes, while all quantities invariant to the underlying orbital representation (e.g.,  $E_{xx}$ ) are left unmodified. By plugging eq 2 into eq 3, one can see that the input orbitals ( $\tilde{\Phi}$ ) via

$$\tilde{\boldsymbol{\Phi}} = \boldsymbol{\Phi}(\boldsymbol{\Phi}^T)_{:,C} (\boldsymbol{P}_{C,C})^{-1/2} \equiv \boldsymbol{\Phi} \boldsymbol{U}$$
(4)

in which

$$\boldsymbol{U} \equiv (\boldsymbol{\Phi}^{T})_{;,C} (\boldsymbol{P}_{C,C})^{-1/2}$$
(5)

is an  $N_{occ} \times N_{occ}$  unitary matrix that allows one to transform between these orbital representations via a single matrix multiplication. Hence, the noniterative SCDM orbital localization scheme is able to furnish U without the need for system-dependent optimization protocols (e.g., initial guesses, convergence criteria, choice of optimization algorithm), which makes it well-suited to provide the localized orbitals required by exx in the high-throughput SeA framework.

### **II.B.** exx: A Black-Box Linear-Scaling Exact-Exchange Algorithm for Finite-Gap Systems. 
With the completion of the noniterative SCDM localization procedure, one can now perform the following unitary transformation (using U from eq 5)

$$\tilde{\phi}_i(\mathbf{r}) = \sum_j \phi_j(\mathbf{r})(\mathbf{U})_{ji}$$
(6)

to obtain a set of localized orbitals that spans the occupied space and forms a basis for a computationally efficient linearscaling evaluation of all EXX-related quantities needed during hybrid DFT calculations on large-scale finite-gap systems at the  $\Gamma$ -point. This is most easily illustrated by considering the canonical expression for  $E_{\rm xx}$  (shown here for a closed-shell system for simplicity)

$$E_{xx} = -\sum_{ij} \int_{\Omega} \rho_{ij}(\mathbf{r}) v_{ij}(\mathbf{r}) d\mathbf{r}$$
<sup>(7)</sup>

in which the sum includes all pairs of occupied orbitals, the integral is over the entire real-space domain ( $\Omega$ ) in the periodic unit cell,  $\rho_{ij}(\mathbf{r}) \equiv \phi_i(\mathbf{r})\phi_j(\mathbf{r})$  is the orbital-product density, and  $v_{ij}(\mathbf{r})$  is the corresponding orbital-product potential (i.e., the solution to Poisson's equation,  $\nabla^2 v_{ij}(\mathbf{r}) = -4\pi\rho_{ij}(\mathbf{r})$ ). In typical planewave/pseudopotential codes, this expression is evaluated with cubic-scaling cost using the conventional convolution-based EXX algorithm.<sup>20</sup> The fact that eq 7 is invariant to the unitary transformation in eq 6 forms the theoretical foundation for the  $\exp algorithm^{47,49}$  in QE, which utilizes a basis of localized orbitals (MLWFs in previous work and SCDM in the current work) to exploit the following two levels of sparsity during the real-space evaluation of  $E_{xx}$ :

- Pair selection: only spatially overlapping orbitals ⟨ij⟩ need to be included when evaluating eq 7 in a localized basis; since each localized orbital φ<sub>i</sub>(**r**) has compact support and will only overlap with a limited and constant-scaling number of neighboring orbitals, exploiting this level of sparsity reduces the total number of orbital pairs from quadratic to linear (Σ<sub>ij</sub> → Σ<sub>(ij)</sub>) in eq 7.
- Domain truncation: for each overlapping  $\langle ij \rangle$  pair, the spatial integral in eq 7 only needs to be evaluated on a domain which encompasses  $\tilde{\rho}_{ij}(\mathbf{r}) \equiv \tilde{\phi}_i(\mathbf{r}) \tilde{\phi}_j(\mathbf{r})$ ; hence, this integral can be performed on a series of orbital-pair-specific domains  $\Omega_{ij}$  that are independent of the system size  $\left(\int_{\Omega} \rightarrow \int_{\Omega_{ij}}\right)$ .

By harnessing these two levels of computational savings, exx enables an efficient linear-scaling evaluation of eq 7, which can now be rewritten in the following working form:

$$E_{xx} = -\sum_{\langle ij \rangle} \int_{\Omega_{ij}} \tilde{\rho}_{ij}(\boldsymbol{r}) \tilde{v}_{ij}(\boldsymbol{r}) d\boldsymbol{r}$$
(8)

in which  $\tilde{\rho}_{ij}(\mathbf{r})$  and  $\tilde{v}_{ij}(\mathbf{r})$  are the orbital-product density and corresponding orbital-product potential in the localized representation. After determining the set of overlapping pairs,  $e_{XX}$  computes  $\tilde{v}_{ij}(\mathbf{r})$  for a given  $\langle ij \rangle$  pair via the iterative (conjugate gradient) solution to Poisson's equation (PE)

$$\nabla^2 \tilde{\nu}_{ij}(\mathbf{r}) = -4\pi \tilde{\rho}_{ij}(\mathbf{r}) \quad \mathbf{r} \in \Omega_{ij}$$
<sup>(9)</sup>

in the near-field region (i.e., for  $r \in \Omega_{ij}$ ), in conjunction with boundary conditions provided by a sufficiently converged multipole expansion (ME):

$$\tilde{v}_{ij}(\mathbf{r}) = 4\pi \sum_{lm} \frac{Q_{lm}}{(2l+1)} \frac{Y_{lm}(\theta, \varphi)}{r^{l+1}} \quad \mathbf{r} \in \partial \,\Omega_{ij}$$
(10)

In this expression,  $Y_{lm}(\theta, \varphi)$  are the spherical harmonics and  $Q_{lm}$  are the multipole moments associated with  $\tilde{\rho}_{ii}(\mathbf{r})$ , i.e.

$$Q_{lm} = \int_{\Omega_{ij}} Y^*_{lm}(\theta, \varphi) r^l \tilde{\rho}_{ij}(\mathbf{r}) d\mathbf{r}$$
(11)

In addition to the EXX contribution to the energy, hybrid DFT calculations also require evaluation of

<span id="page-4-0"></span><span id="page-4-0"></span>
$$D_{xx}^{i}(\boldsymbol{r}) \equiv -\left(\frac{\delta E_{xx}}{\delta \phi_{i}^{*}(\boldsymbol{r})}\right) = -\hat{V}_{xx} \ \phi_{i}(\boldsymbol{r})$$
(12)

a quantity that is often referred to as the EXX contribution to the wave function forces in the AIMD community, as it is needed to propagate the CPMD equations of motion. Of particular relevance to this work is the fact that  $D_{xx}^i(r)$  is also equivalent (to within a sign) to the action of the EXX operator  $(\hat{V}_{xx})$  on the (proto-)KS orbitals, a quantity that is needed to construct the xc potential during SCF calculations at the hybrid DFT level. While the evaluation of the canonical expression for  $D_{xx}^i(r)$  (shown here for a closed-shell system, *cf.* eq 7)

$$D_{xx}^{i}(\boldsymbol{r}) = \sum_{j} v_{ij}(\boldsymbol{r}) \phi_{j}(\boldsymbol{r}) \quad \boldsymbol{r} \in \Omega$$
(13)

is typically the computational bottleneck during the iterative SCF procedure, this quantity can also be efficiently computed in  $e_{XX}$  by exploiting the two levels of sparsity inherent to a localized basis (i.e., pair selection and domain truncation). Since each localized orbital has compact support in real space, the sum over all orbitals in eq 13 can again be replaced by a sum over overlapping orbitals only  $(\sum_{j} \rightarrow \sum_{j \in \langle ij \rangle})$ , with each contribution only needing to be evaluated on an orbital-specific and system-size-independent domain  $(\Omega \rightarrow \Omega_{ij}^{D}, vide infra)$  that encompasses  $\tilde{\phi}_{j}(\mathbf{r})$ . Hence,  $e_{XX}$  also enables an efficient linear-scaling evaluation of eq 13, which can now be rewritten in the following working form:

$$\tilde{D}_{xx}^{i}(\boldsymbol{r}) = \sum_{j \in \langle ij \rangle} \tilde{v}_{ij}(\boldsymbol{r}) \tilde{\phi}_{j}(\boldsymbol{r}) \quad \boldsymbol{r} \in \Omega_{ij}^{D}$$
(14)

in which  $\tilde{v}_{ij}(\mathbf{r})$  in the near-field region (for  $\mathbf{r} \in \Omega_{ij}$ ) is provided by the solution to the PE in eq 9, while  $\tilde{v}_{ij}(\mathbf{r})$  in the far-field region (for  $\mathbf{r} \in \Omega_{ij}^D \setminus \Omega_{ij}$ ) is provided by the ME in eq 10. Unlike  $E_{xx}$ ,  $\tilde{D}_{xx}^i(\mathbf{r})$  is not invariant to the underlying orbital representation and is therefore dressed with a tilde (following the convention used for noninvariant quantities in refs 47 and 49). However, the canonical form of this quantity in eq 13 is straightforwardly obtained from the local form in eq 14 via the following unitary transformation:

$$D_{xx}^{i}(\boldsymbol{r}) = \sum_{j} \tilde{D}_{xx}^{j}(\boldsymbol{r}) (\boldsymbol{U}^{-1})_{ji}$$
(15)

in conjunction with the *U* provided by the orbital localization scheme (MLWFs in previous work and SCDM in the current work; see eq 6). Here, we note that this transformation is of particular relevance to this work as it allows the linear-scaling exx algorithm to directly attack the computational bottleneck (i.e., the evaluation of  $\{D_{xx}^i(\mathbf{r})\}$  or  $\{\hat{V}_{xx} \ \phi_i(\mathbf{r})\}$  in eq 12) that prohibits the routine use of hybrid DFT in applications involving large-scale condensed-phase systems—the central idea in the high-throughput SeA framework developed herein (see section II.D).

With a massively parallel hybrid MPI/OpenMP implementation<sup>47,49</sup> in the CP module of QE<sup>52</sup> (in conjunction with onthe-fly MLWF localization<sup>53</sup>), exx has enabled hybrid DFT based AIMD/CPMD simulations of large-scale condensedphase systems containing 500–1000 atoms in the *NVE/NVT* and *NpH/NpT* ensembles with a wall time cost that is comparable to GGA-based KS-DFT<sup>47,49</sup> and has been used to perform a number of challenging theoretical applications to date.<sup>33,54–60</sup> However, the direct use of this version of  $\approx xx$  would not meet the *implicit* robustness requirements of a high-throughput hybrid DFT framework (i.e., black-box/automatable algorithms), since this implementation relies on a set of system-dependent parameters to harness the two levels of computational savings described above (i.e., a pair distance cutoff ( $R_{\text{pair}}$ ) for pair selection, PE radii ( $R_{\text{PE}}^{\text{ss}}$ ,  $R_{\text{PE}}^{\text{ns}}$ ) and ME radii ( $R_{\text{ME}}^{\text{ss}}$ ,  $R_{\text{ME}}^{\text{ns}}$ ) for domain truncation; see refs 47 and 49 for more details).

To address this shortcoming, we now briefly describe a recent extension<sup>62</sup> of exx that replaces all five of these parameters with a single system-*independent* orbital coverage threshold ( $\varepsilon$ ). More specifically,  $\varepsilon$  forms the basis for the *domain truncation* protocol in exx, in which an orbital-specific and system-size-independent domain ( $\Omega_{ii} \subset \Omega$ ) is first determined for each  $\tilde{\phi}_i(\mathbf{r})$  according to the following orbital normalization condition:

$$1 = \int_{\Omega} |\tilde{\phi}_{i}(\boldsymbol{r})|^{2} \mathrm{d}\boldsymbol{r} \ge \int_{\Omega_{ii}} |\tilde{\phi}_{i}(\boldsymbol{r})|^{2} \mathrm{d}\boldsymbol{r} \ge 1 - \varepsilon$$
(16)

In other words,  $\varepsilon$  specifies the level of (numerical) compliance in the orbital normalization condition (i.e., an upper bound in the fractional particle loss) when determining the domain  $\Omega_{ii}$ that encompasses each  $\tilde{\phi}_i(\mathbf{r})$ . In practice,  $\varepsilon$  is a small ( $\varepsilon \ll 1$ ) dimensionless parameter, which is systematically improvable, i.e., as  $\varepsilon \to 0$ ,  $\Omega_{ii} \to \Omega \forall \tilde{\phi}_i$  and the error due to domain truncation vanishes. As such,  $\varepsilon$  provides an *a priori* estimation<sup>34,62</sup> of the accuracy in all EXX-related quantities computed using this approach (*vide infra*).

In this recently extended version of  $\exp(n^{62})$  each  $\Omega_{ii}$  is represented by a tight axis-aligned bounding box (AABB) with respect to the underlying real-space grid—a parallelepiped that accounts for the anisotropy in the shape and extent of each localized orbital by construction, and provides a natural framework for *simultaneously* and *consistently* exploiting the two levels of sparsity described above. To proceed,  $\bigotimes x$  completes the domain truncation process by finding the set of orbitalpair-specific domains  $\Omega_{ij} \equiv \Omega_{ii} \cap \Omega_{jj}$ . In doing so,  $\bigotimes x$ simultaneously initiates the *pair selection* process by identifying a set of proto- $\langle ij \rangle$  pairs with  $\Omega_{ij} \neq \emptyset$ . To complete the pair selection process and arrive at the final (and significantly smaller) set of  $\langle ij \rangle$  pairs,  $\bigotimes x$  then further screens the proto- $\langle ij \rangle$  pairs according to the following absolute orbital overlap criterion:

$$S_{|i,j|} \equiv \int_{\Omega_{ij}} |\tilde{\phi}_{i}(\boldsymbol{r}) \tilde{\phi}_{j}(\boldsymbol{r})| d\boldsymbol{r} = \int_{\Omega_{ij}} |\tilde{\rho}_{ij}(\boldsymbol{r})| d\boldsymbol{r} \ge \delta$$
(17)

In this expression,  $\delta = \delta(\varepsilon) > 0$  is automatically determined in exx to maximize transferability across systems with varying degrees of heterogeneity. As described in ref 62, this is accomplished by ensuring that the pair selection error (governed by  $\delta$  in eq 17) is smaller than (but comparable to) the domain truncation error (governed by  $\varepsilon$  in eq 16). Here, we note in passing that the use of an absolute orbital overlap criterion during pair selection in exx was inspired by refs 43 and 44; however, the integral in eq 17 is restricted to  $\Omega_{ij}$  in exx instead of the entire real-space domain  $\Omega$ , which forms the basis for a linear-scaling pair-selection protocol.

Following the detailed derivation provided in ref 62,  $\Omega_{ij}^D$  was set to scale<sub>2×</sub>  $\Omega_{ii}$  (for j = i) and  $\Omega_{ji}$  (for  $j \neq i$ ) when computing <span id="page-5-0"></span><span id="page-5-0"></span> $\{\tilde{D}_{xx}^{i}(\mathbf{r})\}\$  via eq 14, which enables an accurate and efficient linear-scaling evaluation of these mission-critical terms (*vide infra*). As described in ref 62, this theoretical extension of  $\oplus xx$  is quite robust and able to treat both homogeneous and heterogeneous (i.e., multiphase and/or multicomponent) systems with controllable accuracy, i.e., with an *a priori* estimated error. We have also completely overhauled the  $\oplus xx$  codebase with a comprehensive three-pronged algorithmic strategy designed to increase computational efficiency, decrease communication overhead, and minimize processor idling, which makes this version well-suited to be the core EXX engine in the high-throughput SeA framework. To maximize the impact of these developments, we also plan to release this EXX engine as a free software library ( $\oplus xx1$ ).

### II.C. ACE: An Efficient Low-Rank Approximation to the Exact-Exchange Operator. 
While the combined use of SCDM and this recently extended version of exx already provides a robust, accurate, and efficient core EXX engine for high-throughput hybrid DFT calculations of large-scale finitegap systems, there is a third level of computational savings (independent from the two levels provided by SCDM + exx) that could be harnessed to further increase the efficiency of the SCF procedure for hybrid functionals. As pointed out by Lin,<sup>3</sup> the most computationally demanding steps during the iterative solution to the KS-DFT equations at the hybrid level-the repeated evaluation of the action using the standard/full-rank EXX operator (e.g.,  $\{\hat{V}_{xx} \phi_i\}$  in eqs 12 and 13)—can be replaced with more efficient evaluations of these terms using a low-rank approximation for  $\hat{V}_{xx}$  (i.e., the adaptively compressed exchange (ACE) operator,  $\hat{V}_{xx}^{ACE}$ ). As outlined in Algorithm 1, the ACE approach exploits the double-loop SCF structure commonly used when performing hybrid DFT calculations in condensed-phase electronic structure packages like QE. Although  $\hat{V}_{\rm xx}^{\rm ACE}$  can in principle be constructed from (and applied to) both occupied and virtual/unoccupied (proto-)KS orbitals,<sup>36</sup> we will limit our discussion below to the ACE procedure involving occupied (proto-)KS orbitals only. We note in passing that this choice is not an intrinsic limitation of the SeA approach developed in this work, and an extension to include virtual (proto-)KS orbitals is underway in our group and will be discussed in future work.

| Algorithm 1: EXX-SCF procedure with ACE                              |
|----------------------------------------------------------------------|
| while $\{ \phi_i\rangle\}$ not converged do                          |
| // outer loop                                                        |
| ACE_Construction( $\{\phi_i\}$ ; $\hat{V}_{xx}^{ACE}$ );             |
| $\{\chi_i\} \leftarrow \{\phi_i\}$ ;                                 |
| while $\{\chi_i\}$ not converged do                                  |
| // inner loop                                                        |
| $\rho(\mathbf{r}) \leftarrow \sum_i  \chi_i(\mathbf{r}) ^2$ ;        |
| SCF_Iteration( $\rho(\mathbf{r}), \hat{V}_{xx}^{ACE}; \{\chi_i\}$ ); |
| end                                                                  |
| $\{\phi_i\} \leftarrow \{\chi_i\}$ ;                                 |
| end                                                                  |

During each outer-loop iteration in the EXX-SCF procedure with ACE (see Algorithm 1), the ACE\_Construction step (the bottleneck for large-scale hybrid DFT calculations) takes the current set of proto-KS orbitals  $\{|\phi_i\rangle\}$  as input and performs a full-rank evaluation of the action to obtain  $\{\hat{V}_{xx}|\phi_i\rangle\}$ . Since  $|D_{xx}^i\rangle = -\hat{V}_{xx}|\phi_i\rangle$  via eq 12, the use of  $|D_{xx}^i\rangle$  instead of  $\hat{V}_{xx}|\phi_i\rangle$  will lead to a sign difference in certain quantities (e.g.,  $M_{ij}$  below) when compared to the original ACE formulation.<sup>36</sup> In this section, we use bra-ket notation to emphasize the fact that the ACE approach is independent of the underlying representation; in other words, one has the flexibility to work in real and/or reciprocal space (i.e., using  $D_{xx}^i(\mathbf{r}) = \langle \mathbf{r} | D_{xx}^i \rangle$  and/or  $D_{xx}^i(\mathbf{G}) = \langle \mathbf{G} | D_{xx}^i \rangle$ ). The output of ACE\_Construction is the ACE operator:

$$\hat{V}_{xx}^{ACE} = -\sum_{k} |\xi_{k}\rangle \langle \xi_{k}|$$
(18)

a low-rank approximation of  $\hat{V}_{xx}$  that is obtained via a Cholesky decomposition of the  $N_{occ} \times N_{occ}$  symmetric positive semidefinite matrix  $M_{ij} \equiv \langle \phi_i | D_{xx}^j \rangle = -\langle \phi_i | \hat{V}_{xx} | \phi_j \rangle = (\mathbf{L}\mathbf{L}^T)_{ij}$ , which yields  $|\xi_k\rangle \equiv -\sum_i |D_{xx}^i\rangle (\mathbf{L}^{-T})_{ik}$  for  $k = 1, ..., N_{occ}$ .

With the completion of the ACE\_Construction step, a set of auxiliary orbitals,  $\{|\chi_i\rangle\}$ , is initialized to the current set of proto-KS orbitals  $(\{|\chi_i\rangle\} \leftarrow \{|\phi_i\rangle\})$  as one enters the inner loop in Algorithm 1. Inside the inner loop, the KS-DFT equations are iteratively solved with a series of calls to the SCF\_Iteration step, which takes  $\rho(r) = \sum_i |\chi_i(r)|^2$  (the charge density in real space) and  $\hat{V}_{xx}^{ACE}$  as input. During each SCF\_Iteration call,  $\rho(r)$  is used to construct the semilocal (non-EXX) contribution to the KS Hamiltonian and  $\hat{V}_{xx}^{ACE}|\chi_i\rangle$  (evaluated with the *fixed*  $\hat{V}_{xx}^{ACE}$  operator) is used to compute the EXX action. Throughout the inner-loop iterations,  $\{|\chi_i\rangle\}$  and the semilocal contributions to the KS Hamiltonian are updated toward self-consistency, while  $\hat{V}_{xx}^{ACE}$  remains fixed/unmodified. Upon convergence of the auxiliary orbitals, the code exits the inner loop and the proto-KS orbitals are updated  $(\{|\phi_i\rangle\} \leftarrow \{|\chi_i\rangle\})$  for the next outer-loop iteration.

The ACE-based EXX-SCF procedure in Algorithm 1 is completed once the proto-KS orbitals in the outer loop reach self-consistency, which is equivalent to a fully self-consistent hybrid DFT calculation. At this point,  $\hat{V}_{xx}^{ACE}$  reproduces the action of  $\hat{V}_{xx}$  on the occupied KS orbitals, and the EXX energy can be conveniently evaluated via (shown here for a closed-shell system at the  $\Gamma$ -point for consistency with eqs 7 and 12):

$$E_{\rm xx} = \sum_{i} \langle \phi_i | \hat{V}_{\rm xx}^{\rm ACE} | \phi_i \rangle = -\sum_{ik} |\langle \phi_i | \xi_k \rangle|^2 \tag{19}$$

in which each sum is over the converged occupied KS orbitals. By replacing the more costly evaluations of the action using  $\hat{V}_{xx}$  with  $\hat{V}_{xx}^{ACE}$ , the ACE approach offers an additional level of computational savings (on top of the two provided by SCDM + exx) that can be harnessed to attack the most computationally demanding steps during the iterative solution to the KS equations at the hybrid DFT level, thereby making it wellsuited to further improve the efficiency and throughput of the SeA framework.

### **II.D. SeA (SCDM + exx + ACE): High-Throughput Hybrid DFT for Large-Scale Finite-Gap Systems.** 
In this section, we describe how SeA combines and seamlessly integrates SCDM, exx, and ACE into a robust, accurate, and computationally efficient framework (which has been implemented in PWSCF) for performing high-throughput condensed-phase hybrid DFT calculations on large-scale finite-gap systems. For a robust, accurate, and efficient evaluation of the action using the standard/full-rank EXX operator  $(\{\hat{V}_{xx}|\phi_i\rangle\})$ the typical bottleneck during SCF calculations at the hybrid DFT level—SeA employs the noniterative SCDM procedure for localized orbital generation described in section II.A in conjunction with the recently extended black-box version<sup>62</sup> of exx described in section II.B. To further improve the overall efficiency and throughput, SEA also employs the ACE operator formalism described in section II.C to reduce the number of times that  $\{\hat{V}_{xx}|\phi_i\rangle\}$  (or  $\{|D_{xx}^i\rangle\}$ ) needs to be evaluated during the iterative solution to the KS-DFT equations. In doing so, SeA harnesses three distinct levels of computational savings by reducing the number of calls to the most computationally demanding step in hybrid DFT calculations (ACE, one level of savings) and also drastically reducing the cost of evaluating each of the remaining calls (SCDM + exx, two levels of savings). As mentioned above, SeA was inspired by the work of Gygi and co-workers,<sup>32,34</sup> Giannozzi and co-workers,<sup>43</sup> and Nair and co-workers,<sup>44,45,48</sup> but differs from these pioneering works (which harnessed one or two levels of computational savings via pair selection and ACE) by harnessing three levels of savings (pair selection, domain truncation, and ACE) to further enable the routine use of hybrid DFT in high-throughput applications involving largescale finite-gap systems.

<span id="page-6-0"></span><span id="page-6-0"></span>Image /page/6/Figure/3 description: The image shows a diagram of ACE construction, including PWSCF (ACE), SeA, and Low-Rank Decomposition. The PWSCF (ACE) section shows a series of steps involving vexx, {φi(r)}, {ρij(r)}, {vij(r)}, and {Dxx(r)}, which are transformed using invFFT and fwdFFT to {φi(G)}, {ρij(G)}, {vij(G)}, and {Dxx(G)}. The SeA section shows steps involving SCDM, exx, and rot\_D, with {φi(r)}, {φ˜i(r)}, and {D˜xx(r)} being transformed using invFFT and fwdFFT to {φi(G)} and {Dxx(G)}, with U connecting {φ˜i(r)} and {φi(G)}. The Low-Rank Decomposition section shows decomp transforming {φi(G)} + {Dxx(G)} to {ξi(G)}, which is then used to calculate VˆACE xx = −Σk |ξk⟩⟨ξk|.

Figure 2. Schematic illustration of the ACE\_Construction step in: (a) PWSCF (ACE), the convolution-based ACE implementation in PWSCF; and (b) SeA, the high-throughput hybrid DFT framework presented in this work. Starting from the (proto-)KS orbitals (i.e.,  $\{\phi_i(G)\}$  in reciprocal space), both PWSCF (ACE) and SeA proceed to compute  $D_{xx}^i(G) = -\hat{V}_{xx}\phi_i(G) \forall i$  (i.e., the action of the full-rank EXX operator needed during the iterative EXX-SCF procedure in hybrid DFT calculations, see Algorithm 1). Then, both methods merge at: (c) a common low-rank decomposition function (decomp) that builds  $\hat{V}_{xx}^{ACE}$  from  $\{D_{xx}^i(G)\}$  and  $\{\phi_i(G)\}$ . Pale blue (red) backgrounds indicate the real-space (reciprocal-space) aspects of each method. Single yellow and green boxes (with fwdFFT or invFFT enclosed) depict a linear ( $O(N_{occ})$ ) number of FFT calls, while triple yellow boxes represent a quadratic ( $O(N_{occ}^2)$ ) number of FFT calls. Each fwdFFT/invFFT call was performed at the appropriate planewave resolution for each method—the density/potential FFT grid for vexx in PWSCF (ACE) ( $N_{FFT}$  points; yellow boxes) and the wave function FFT grid for SeA ( $N_{FFT}^{wf} < N_{FFT}$  points; green boxes). For more details, a pedagogical walk-through of the ACE\_Construction step is provided in section II.D.

More specifically, SeA involves a key modification to the ACE-based EXX-SCF procedure, which already offers tremendous speedups during hybrid DFT calculations by replacing the repeated evaluation of  $\{\hat{V}_{xx}|\phi_i\rangle\}$  in the conventional EXX-SCF procedure with a significantly more efficient evaluation of this term using  $\hat{V}_{xx}^{ACE}$ . In the ACE-based EXX-SCF procedure depicted in Algorithm 1, the construction of  $\hat{V}_{xx}^{ACE}$  is the computational bottleneck (particularly for largescale systems) and is accomplished via calls to the ACE Construction step during each outer-loop iteration. To eliminate this step as the bottleneck during such large-scale hybrid DFT calculations, SeA directly attacks the cost of executing the ACE Construction step by using SCDM + exx to compute  $\{\hat{V}_{xx}|\phi_i\}$  (or  $\{|D_{xx}^i\rangle\}$ ). To illustrate the combination and seamless integration of these methods in more detail, we will focus the remainder of this discussion on a  $\Gamma$ -point specific algorithm (i.e., as the target applications of SeA are high-throughput hybrid DFT calculations on largescale systems); a more general extension of SeA based on Brillouin zone sampling will be discussed in future work. Since  $|D_{xx}^i\rangle$  is equivalent to  $\hat{V}_{xx}|\phi_i\rangle$  (to within a sign, cf. eq 12 and section II.B) and is naturally aligned with the exx framework,  $^{47,49,62}$  we will set  $|D_{xx}^i\rangle$  as the target quantity in the ACE Construction step. As mentioned above in section II.C, we will also limit our discussion to the ACE procedure involving occupied (proto-)KS orbitals only; an extension of SEA to include virtual/unoccupied orbitals will also be discussed in future work.

To start, we first consider the ACE \_Construction step in the convolution-based ACE algorithm in the PWSCF module of QE, which will be referred to as PWSCF (ACE) throughout the remainder of this work. In PWSCF (ACE), the ACE Construction step (as illustrated in Figure 2) includes a full-rank EXX evaluation to obtain  $\{D_{xx}^{i}(G)\}$  (via the vexx function, Figure 2a) followed by a low-rank decomposition to obtain  $\hat{V}_{xx}^{ACE}$  (via the decomp function, Figure 2c). During a  $\Gamma$ -point calculation, vexx first obtains the (proto-)KS orbitals in real space ( $\{\phi_i(r)\}$ ) from their stored  $N_{pw}$  planewave coefficients  $(\{\phi_i(G)\})$  via the inverse FFT (invFFT). The complete set of orbital-product densities  $\{\rho_{ii}(\mathbf{r})\}$  is then constructed (as products over the  $N_{occ}(N_{occ} +$ 1)/2 unique pairs of  $\{\phi_i(\mathbf{r})\}$  and converted to reciprocal space  $(\{\rho_{ij}(\mathbf{r})\} \rightarrow \{\rho_{ij}(\mathbf{G})\})$  using the forward FFT (fwdFFT). Based on the convolution theorem, the corresponding orbital-product potentials are evaluated as  $v_{ii}(G)$  =  $4\pi \rho_{ii}(G)/|G|^2$ , which is again brought back to real space via the invFFT to form  $\{v_{ii}(r)\}$ . Then,  $\{D_{xx}^{i}(r)\}$  is formed in real space via  $D_{xx}^{i}(r) = \sum_{i} v_{ii}(r) \phi_{i}(r)$  as described in eq 13 and converted to the targeted  $\{D_{xx}^{i}(G)\}$  via the fwdFFT. Hence, the cost of vexx is primarily governed by the two FFT operations involving  $\{\rho_{ij}\}$  and  $\{v_{ij}\}$  (each of which scales as  $O(N_{\rm FFT}\log N_{\rm FFT}))$  for each of the  $O(N_{\rm occ}^2)$  unique pairs of occupied orbitals, which leads to an overall cubic-scaling algorithm (i.e.,  $O(N_{occ}^2 N_{FFT} \log N_{FFT}))$  after neglecting the logarithmic term. After obtaining the targeted  $\{D_{xx}^{i}(G)\}$ , PWSCF (ACE) completes the ACE Construction step with a call to decomp, a function which constructs  $\hat{V}_{\rm xx}^{\rm ACE}$  via eq 18 using the stored  $\{\phi_i(G)\}$ . The procedure for constructing  $\hat{V}_{\rm xx}^{\rm ACE}$  is schematically illustrated in Figure 2c (and covered in more detail in section II.C) and also requires cubic-scaling cost  $(O(N_{pw}N_{occ}^2 + N_{occ}^3))$ . To ensure lossless fwdFFT/invFFT between  $\rho_{ii}(\mathbf{r}) \leftrightarrow \rho_{ii}(\mathbf{G})$  and  $\nu_{ii}(\mathbf{r}) \leftrightarrow$  $v_{ii}(G)$  in vexx necessitates the use of the density/potential FFT grid (with  $N_{\rm FFT}$  points). Since  $N_{\rm FFT}$  >  $N_{\rm pw}$ , vexx generally dominates decomp and is almost always the computational bottleneck during the ACE Construction step in PWSCF (ACE).

To greatly improve the computational efficiency of hybrid DFT calculations (particularly for large-scale systems), SEA directly attacks this computational bottleneck by replacing vexx with a procedure based on the combination of SCDM and exx. As depicted in Figure 2b, the ACE Construction step in SeA also starts from the stored  $N_{\rm pw}$  planewave coefficients ({ $\phi_i(G)$ }), from which the { $\phi_i(r)$ } are obtained via invFFT. However, this operation is performed at a planewave resolution that is sufficient to ensure lossless  $\{\phi_i(\boldsymbol{G})\} \xrightarrow{\text{invFFT}} \{\phi_i(\boldsymbol{r})\} \text{ and } \{\tilde{D}_{xx}^i(\boldsymbol{r})\} \xrightarrow{\text{fwdFFT}} \{\tilde{D}_{xx}^i(\boldsymbol{G})\}, \text{ namely,}$ the wave function FFT grid with  $N_{\rm FFT}^{\rm wf}$  <  $N_{\rm FFT}$  points. As discussed in more detail below, this is the appropriate planewave resolution for the exx function in Figure 2b, since SeA directly forms  $\{\tilde{D}_{xx}^{i}(\boldsymbol{r})\}$  from  $\{\phi_{i}(\boldsymbol{r})\}$  in real space and therefore completely sidesteps the need for  $\{\rho_{ii}(G)\}$  and  $\{v_{ij}(G)\}$ —the central quantities in vexx (cf. Figure 2a). With  $N_{\rm FFT}^{\rm wf}$  <  $N_{\rm FFT}$  (i.e.,  $N_{\rm FFT}^{\rm wf} \approx N_{\rm FFT}/8$  when implemented with norm-conserving pseudopotentials), using the appropriate planewave resolution plays a significant role in increasing the computational efficiency (as well as decreasing the memory footprint, communication overhead, and processor idling) in exx; a more detailed discussion of this theoretical and algorithmic development will be provided in future work accompanying the public release of the exxl library.

With  $\{\phi_i(\mathbf{r})\}$  on the wave function FFT grid, SeA applies the noniterative SCDM algorithm (i.e., by calling the SCDM function) to obtain the localized orbitals in real space  $\{\phi(\mathbf{r})\}$ and the corresponding unitary matrix U that allows one to transform between the local and canonical orbital representations (see section II.A); with the use of the appropriate planewave resolution in SEA, execution of SCDM has a reduced cubic-scaling cost of  $O(N_{\text{FFT}}^{\text{wf}}N_{\text{occ}}^2 + N_{\text{occ}}^3)$ . With the localized SCDM orbitals in hand, SEA then calls the linearscaling exx routine, which harnesses two levels of computational savings during the real-space evaluation of  $\{\tilde{D}_{xx}^{i}(r)\}$  via eq 14 at  $O(N_{occ})$  cost (see section II.B). In doing so, SeA replaces the computationally dominant FFT operations involving  $\{\rho_{ij}\}$  and  $\{v_{ij}\}$  in vexx with a noniterative cubicscaling localization routine and a linear-scaling evaluation of  $\{\tilde{D}_{xx}^{i}(\boldsymbol{r})\}$ . Here, we remind the reader that the recently extended version<sup>62</sup> of exx included in SeA is based on a single system-independent orbital coverage threshold (instead of the set of system-dependent parameters used in previous exx versions<sup>47,49</sup>), which allows for a more straightforward (i.e., single-knob) tuning of the balance between accuracy and performance during this critical step in the ACE\_Construction step. Then, SeA calls the rot D function, which first transforms  $\{\tilde{D}'_{xx}(\boldsymbol{r})\}$  to  $\{\tilde{D}'_{xx}(\boldsymbol{G})\}$  via fwdFFT with a quadratic-scaling cost of  $O(N_{\rm occ}N_{\rm FFT}^{\rm wf}\log N_{\rm FFT}^{\rm wf})$  after neglecting the logarithmic term; this step is the local representation analogue of the  $\{D_{xx}^{i}(\boldsymbol{r})\} \xrightarrow{\text{fwdFFT}} \{D_{xx}^{i}(\boldsymbol{G})\}$  transformation in vexx (albeit with reduced computational cost). To form the targeted  $\{D_{xx}^{i}(\boldsymbol{G})\}$ , rot D then rotates  $\{\tilde{D}_{xx}^{i}(\boldsymbol{G})\}$  via

$$D_{xx}^{i}(\boldsymbol{G}) = \sum_{j} \tilde{D}_{xx}^{j}(\boldsymbol{G})(\boldsymbol{U}^{-1})_{ji}$$
(20)

with a cubic-scaling associated cost of  $O(N_{pw}N_{occ}^2)$ . Here, we emphasize that the availability of the U matrix in SeA (provided by the earlier call to SCDM) facilitates this transformation, leveraging a strategy previously pointed out by Nair and co-workers.<sup>44</sup> While the order in which the fwdFFT and unitary rotation are applied leads to the same  $\{D_{xx}^i(G)\}$ , the order employed in rot\_D is the more computationally efficient of the two. More specifically, the procedure in rot\_D  $(\{\tilde{D}_{xx}^i(r)\} \xrightarrow{\text{fwdFFT}} \{\tilde{D}_{xx}^i(G)\} \xrightarrow{U^{-1}} \{D_{xx}^i(G)\})$  has an associated computational cost of  $O(N_{occ}N_{\text{FFT}}^{\text{wf}}\log N_{\text{FFT}}^{\text{wf}} + N_{pw}N_{occ}^2)$ , while the alternative choice  $(\{\tilde{D}_{xx}^i(r)\} \xrightarrow{U^{-1}} \{D_{xx}^i(r)\} \xrightarrow{\text{fwdFFT}} \{D_{xx}^i(G)\})$  s cales as  $O(N_{\text{FFT}}^{\text{wf}}N_{occ}^2 + N_{occ}N_{\text{FFT}}^{\text{wf}}\log N_{\text{FFT}}^{\text{wf}})$ . As such, the rot\_D routine leverages the fact that  $N_{\text{FFT}}^{\text{wf}} > N_{pw}$  for lossless fwdFFT and invFFT to further improve the efficiency of SeA.

After obtaining the targeted  $\{D_{xx}^{i}(G)\}$ , SEA merges with PWSCF(ACE) by calling the common decomp function described above (Figure 2c) to obtain  $\hat{V}_{xx}^{ACE}$  and complete the ACE\_Construction step. Here, we note that an approximate evaluation of  $\{D_{xx}^{i}\}$  can lead to a nonsymmetric and/or nonpositive-semidefinite M matrix (with elements  $M_{ii} \equiv \langle \phi_{i} | D_{xx}^{j} \rangle$ ), which will render the Cholesky decomposition procedure in decomp unstable (see eq 18 and surrounding discussion). To address this potential stability issue, we have implemented an alternative/generalized low-rank decomposition scheme in the decomp function called by SeA; this eigensystem-based procedure is described in Appendix A and also comes with a cubic-scaling cost of  $O(N_{occ}^3 + N_{occ}^2 N_{pw})$ . In practice, this alternative decomposition scheme seems to be quite robust for SeA across a broad range of systems, and may also increase the robustness of other approximate ACE-based methods.<sup>43,48</sup>

<span id="page-8-0"></span><span id="page-8-0"></span>Image /page/8/Figure/3 description: The image shows three sets of plots, each set corresponding to a different value of epsilon: 10^-3.0, 10^-3.5, and 10^-4.0. Each set consists of three plots arranged vertically. The top plot in each set is a histogram of density (g/cm^3), with the x-axis ranging from 0.50 to 1.50. The middle plot shows the standard deviation (SD) of [E\_col] in percentage (%) against the speedup in ACE\_Construction. The bottom plot shows the root mean square deviation (RMSD) of [{F}] in (mHa/Bohr) against the speedup in ACE\_Construction. The plots show data points scattered across the graph, with some points highlighted in yellow. Horizontal dashed lines are present in the middle and bottom plots, indicating specific values. The values are 0.025% and 0.30 mHa/Bohr for epsilon = 10^-3.0, 0.004% and 0.19 mHa/Bohr for epsilon = 10^-3.5, and 0.000% and 0.16 mHa/Bohr for epsilon = 10^-4.0. Vertical dashed lines are also present in the middle and bottom plots, indicating specific speedup values. The top plots show the maximum count values: 60.4x for epsilon = 10^-3.0, 40.8x for epsilon = 10^-3.5, and 24.3x for epsilon = 10^-4.0. In the middle plot of the first set, there are two small images showing molecular structures.

Figure 3. Accuracy and performance of SeA in the PWSCF module of QE (compared to the convolution-based PWSCF (ACE) implementation) when computing the EXX energy  $(E_{xx})$  and ionic forces  $(\{F_I\})$  at the PBE0 level for a diverse set of 200 nonequilibrium  $(H_2O)_{64}$  configurations (which include both intact and autoionized water molecules, with system densities 1.7 g/cm<sup>3</sup> > d > 0.4 g/cm<sup>3</sup>) using three typical  $\varepsilon$  settings:  $\varepsilon = 10^{-3.0}$  (left panel),  $\varepsilon = 10^{-3.5}$  (middle panel), and  $\varepsilon = 10^{-4.0}$  (right panel). In each panel, the central (lower) scatter plot depicts the correlation between accuracy and performance when computing  $E_{xx}$  ( $\{F_I\}$ ) with SeA. In the central scatter plot, the accuracy in  $E_{xx}$  was quantified by the relative signed deviation:  $SD[E_{xx}] \equiv (E_{xx}^{SeA} - E_{xx}^{PWSCF(ACE)})/|E_{xx}^{PWSCF(ACE)}|$  (red dashed line = mean  $SD[E_{xx}]$ ). In the lower scatter plot, the accuracy in  $\{F_I\}$  was quantified by the (component-wise) root-mean-square deviation:  $RMSD[\{F_I\}] \equiv \sqrt{\sum_{I} |F_I^{SeA} - F_I^{PWSCF(ACE)|^2}/3N}$  wherein N is the number of atoms (red dashed line = mean  $RMSD[\{F_I\}]$ ). In both of these scatter plots, each point was colored according to the system density (d) and the performance of SeA was quantified by the speedup observed in the wall time cost of the ACE\_Construction step (i.e., the typical computational bottleneck in PWSCF (ACE)). In each panel, the top histogram depicts the distribution of speedups accomplished by SeA (blue dashed line = mean speedup) across these 200 configurations. Each calculation was performed using a single Cori-Haswell node (with 16 MPI processes and 4 OpenMP threads per process).

With  $\hat{V}_{xx}^{ACE}$  in hand (at the end of a given outer-loop iteration), the current version of SeA computes  $E_{xx}$  via eq 19. Here, we note that eq 8 (i.e., the real-space energy expression in the exx approach) is not used in SeA, as the real-space evaluation of this quantity in a planewave code such as QE would be subject to small (but non-negligible) errors due to aliasing. While SeA avoids such potential aliasing errors by using eq 19 to compute  $E_{xxt}$  the approximate evaluation of  $\{D_{xx}^i\}$  due to pair selection and domain truncation in exx can also lead to small numerical instabilities during the SCF procedure, e.g., minor oscillations in the total energy during the outer-loop iterations in SeA (see Algorithm 1). While pair selection in exx is a secondary source of error in  $E_{xx}$  by design (see eq 17 and surrounding discussion in section II.B), pair selection is the primary cause of these numerical instabilities (which is consistent with the findings of Giannozzi and coworkers<sup>43</sup> for L-ACE). In SeA, these oscillations are typically much smaller than the targeted accuracy in  $E_{xx}$ , which is estimated a priori for a given  $\varepsilon$  value.<sup>62</sup> As such, we have constructed and implemented a convergence criterion based on successive idempotency in consecutive outer-loop iterations in SeA, wherein the EXX-SCF procedure converges after reaching this targeted level of accuracy (see Appendix B).

By constructing  $\hat{V}_{\rm xx}^{\rm ACE}$  in the canonical orbital representation (via  $\{\phi_i(G)\}\$  and  $\{D_{xx}^i(G)\}\$  in decomp), the current version of SeA sidesteps the need to work with localized orbitals during the inner-loop iterations in Algorithm 1. While the use of localized orbitals could provide additional computational savings during the inner-loop iterations, such savings would need to be balanced against the cost associated with multiple calls to SCDM; hence, this potential future research direction is beyond the scope of this work. Since  $\hat{V}_{\rm xx}^{\rm ACE}$  is independent of the underlying representation, it would also be possible to construct a fully real-space version of SEA (i.e., by eliminating the fwdFFT in rot D and using  $\{\phi_i(r)\}$  and  $\{D_{xx}^i(r)\}$  to perform the low-rank decomposition in decomp). While a naïve implementation of such an approach in a planewave code would be subject to aliasing errors (which can impede very tight SCF convergence, e.g., as needed for numerical phonon calculations), the incorporation of SEA into a real-space electronic structure code like PARSEC<sup>69</sup> has the potential to enable hybrid DFT calculations across significantly larger length- and time-scales, and may therefore be a promising future research direction.

## III. ACCURACY AND PERFORMANCE OF SeA

In this section, we assess the accuracy (section III.A) and performance (section III.B) of SeA by comparing this approach against the convolution-based ACE implementation in PWSCF (cf. the SeA and PWSCF (ACE) algorithms in Figure 2). The computational details for all electronic structure calculations performed in this work can be found in Appendix C. To do so, we carried out a series of fully self-consistent PBE0<sup>64,65</sup> calculations using SeA and PWSCF (ACE) for 200 randomly selected (H<sub>2</sub>O)<sub>64</sub> configurations (each with a cubic unit cell) that were collected during active learning<sup>70,71</sup> of a deep neural network (DNN) potential for water at the SCAN meta-GGA level of theory,<sup>72</sup> which is known to perform quite well for aqueous systems.<sup>73–79</sup> This set contains a wide range of nonequilibrium configurations (including both intact and autoionized water molecules) with densities ranging from  $\approx 0.4$  g/cm<sup>3</sup> to  $\approx 1.7$  g/cm<sup>3</sup>. As such, this diverse set samples the configuration space of water across a wide range of system densities as well as sectors of configuration space that are relevant to autoionization (i.e.,  $2H_2O \rightleftharpoons H_3O^+ + OH^-$ ). While it is straightforward to apply SeA to significantly larger systems (*vide infra*), our choice to consider  $(H_2O)_{64}$  here allows for a systematic comparison with the more computationally demanding PWSCF (ACE) approach.

<span id="page-9-0"></span><span id="page-9-0"></span>Table 1. Accuracy of SeA in the PWSCF Module of QE (Compared to the Convolution-Based PWSCF (ACE) Implementation) When Computing Scalar Quantities (EXX Energy  $(E_{xx})$ , Valence Band Width (VBW), and Binding Energy  $(E_b)$ ) and Vector Quantities (Ionic Forces ( $\{F_i\}$ ) and Orbital Eigenvalues ( $\{\lambda_i\}$ )) at the PBE0 Level for a Diverse Set of 200 Nonequilibrium ( $H_2O$ )<sub>64</sub> Configurations (Which Include Both Intact and Autoionized Water Molecules, with System Densities 1.7 g/cm<sup>3</sup> > d > 0.4 g/cm<sup>3</sup>) Using Three Typical  $\varepsilon$  Settings:  $\varepsilon = 10^{-3.0}$ ,  $\varepsilon = 10^{-3.5}$ , and  $\varepsilon = 10^{-4.0a}$ 

| Scalar Quantities      |                                                                                                                 |                                  |                                                 |           |                                                                                         |                                            |          |           |           |                                                   |      |      |      |
|------------------------|-----------------------------------------------------------------------------------------------------------------|----------------------------------|-------------------------------------------------|-----------|-----------------------------------------------------------------------------------------|--------------------------------------------|----------|-----------|-----------|---------------------------------------------------|------|------|------|
| Quantity $\rightarrow$ |                                                                                                                 | EXX Energy (%)                   |                                                 |           |                                                                                         | Valence Band Width (eV)                    |          |           |           | Binding Energyb (kcal/mol)                        |      |      |      |
| Level                  | Method                                                                                                          | MSD                              | MAD                                             | RMSD      | MAXD                                                                                    | MSD                                        | MAD      | RMSD      | MAXD      | MSD                                               | MAD  | RMSD | MAXD |
| PBE0                   | SeA $(10^{-3.0})$                                                                                               | 0.025                            | 0.025                                           | 0.025     | 0.035                                                                                   | 0.003                                      | 0.011    | 0.014     | 0.035     | -0.28                                             | 0.28 | 0.28 | 0.38 |
|                        | SeA $(10^{-3.5})$                                                                                               | 0.004                            | 0.004                                           | 0.004     | 0.007                                                                                   | 0.001                                      | 0.005    | 0.007     | 0.020     | -0.12                                             | 0.12 | 0.12 | 0.14 |
|                        | SeA $(10^{-4.0})$                                                                                               | 0.000                            | 0.002                                           | 0.003     | 0.010                                                                                   | 0.000                                      | 0.003    | 0.004     | 0.013     | -0.06                                             | 0.06 | 0.07 | 0.08 |
| PBEc                   | PWSCF                                                                                                           | -                                | -                                               | -         | -                                                                                       | -0.410                                     | 0.410    | 0.720     | 1.390     | 0.54                                              | 0.54 | 0.55 | 0.85 |
| PBE0d                  | PWSCF (ACE)                                                                                                     | $-63.432 \le E_{xx} \le -62.866$ |                                                 |           |                                                                                         | $20.7 \le \text{VBW} \le 25.4$             |          |           |           | $0.95 \le E_b \le 10.91$                          |      |      |      |
|                        |                                                                                                                 | $\mu \pm \sigma$                 | $\mu \pm \sigma = -63.068 \pm 0.074 \text{ Ha}$ |           |                                                                                         | $\mu \pm \sigma = 21.9 \pm 0.7 \text{ eV}$ |          |           |           | $\mu \pm \sigma = 7.46 \pm 1.99 \text{ kcal/mol}$ |      |      |      |
| Vector Quantities      |                                                                                                                 |                                  |                                                 |           |                                                                                         |                                            |          |           |           |                                                   |      |      |      |
| Quantity $\rightarrow$ |                                                                                                                 | Ionic Forces (mHa/Bohr)          |                                                 |           |                                                                                         | Orbital Eigenvalues (eV)                   |          |           |           |                                                   |      |      |      |
| Level                  | Method                                                                                                          | (MSD)200                         | (MAD)200                                        | (RMSD)200 | (MAXD)200                                                                               | (MSD)200                                   | (MAD)200 | (RMSD)200 | (MAXD)200 |                                                   |      |      |      |
| PBE0                   | SeA $(10^{-3.0})$                                                                                               | -e                               | 0.25                                            | 0.30      | 0.95                                                                                    | 0.014                                      | 0.015    | 0.018     | 0.049     |                                                   |      |      |      |
|                        | SeA $(10^{-3.5})$                                                                                               | -e                               | 0.14                                            | 0.19      | 0.61                                                                                    | 0.006                                      | 0.007    | 0.008     | 0.023     |                                                   |      |      |      |
|                        | SeA $(10^{-4.0})$                                                                                               | -e                               | 0.10                                            | 0.16      | 0.55                                                                                    | 0.003                                      | 0.003    | 0.004     | 0.011     |                                                   |      |      |      |
| PBEc                   | PWSCF                                                                                                           | -e                               | 5.70                                            | 6.63      | 14.47                                                                                   | -g                                         | 0.521    | 0.604     | 1.111     |                                                   |      |      |      |
| PBE0d                  | PWSCF (ACE)<br>$12.3 \le \text{RMSD}_0[\{F_I\}]^f \le 28.4$<br>$\mu \pm \sigma = 17.2 \pm 3.3 \text{ mHa/Bohr}$ |                                  |                                                 |           | $-6.2 \le \lambda_{\text{HOMO}} \le -1.1$<br>$\mu \pm \sigma = -4.2 \pm 0.6 \text{ eV}$ |                                            |          |           |           |                                                   |      |      |      |

<sup>*a*</sup>For each scalar quantity, we report the following deviation metrics computed from these 200 configurations: mean signed deviation (MSD), mean absolute deviation (MAD), root-mean-square deviation (RMSD), and maximum absolute deviation (MAXD). For each vector quantity, we compute the component-wise MSD, MAD, RMSD, and MAXD for each configuration, and report the corresponding population mean (denoted by  $\langle \cdots \rangle_{200} \rangle$ , i.e., the deviation metric averaged over the 200 configurations. For a given scalar or vector quantity (*Q*), the above deviation metrics were computed on the difference between SeA and PWSCF (ACE), i.e.,  $Q^{\text{SeA}} - Q^{\text{PWSCF(ACE)}}$ ; as such, a positive MSD corresponds to an overestimate of  $E_{xxy}$  VBW,  $E_{b}$ , or { $\lambda_i$ } by SeA. <sup>b</sup>Binding energies were computed via  $E_b = E_{H_2O(g)} - \frac{1}{64}E_{(H_2O)_{64}}$ . <sup>c</sup>As context for quantifying the reported deviations, we report property-specific deviation metrics between PBE and PBE0 (computed via  $Q^{\text{PBE}} - Q^{\text{PWSCF(ACE)}}$ ). <sup>d</sup>For an additional comparison, we also provide quantity-specific measures for the range of PBE0 values obtained with PWSCF (ACE) for the 200 aqueous configurations; hence,  $\langle \text{MSD} \rangle_{200}$  (the population mean) will vanish. <sup>f</sup>The magnitude of { $F_I$ } in each configuration was quantified by RMSD<sub>0</sub>[{ $F_I$ }]  $\equiv \sqrt{\sum_{I} |F_I|^{\text{PWSCF(ACE)}^2}/3N}$ , in which N is the number of atoms. <sup>g</sup>To account for the vertical energy shift ( $\approx 2.2 \text{ eV}$ ) between the PBE and PBE0 levels of theory, the mean PBE and PBE0 eigenvalues were aligned for each configuration; hence, MSD = 0 for each configuration and  $\langle \text{MSD} \rangle_{200}$  will vanish.

### **III.A.** Accuracy of SeA. 
We begin by discussing the accuracy of SeA when computing  $E_{xx}$  for these 200 nonequilibrium  $(H_2O)_{64}$  configurations using typical settings for  $\varepsilon$  in exx (i.e., the system-independent orbital coverage threshold<sup>62</sup> in eq 16), namely,  $10^{-3} \ge \varepsilon \ge 10^{-4}$ . As depicted in Figure 3 and Table 1, the use of successively smaller  $\varepsilon$  values consistently reduces the mean signed deviation (MSD) in  $E_{xx}$  between SeA and PWSCF (ACE) from 0.025% ( $\varepsilon = 10^{-3.0}$ ) to a visible plateau at 0.004% ( $\varepsilon = 10^{-3.5}$ ) and 0.000% ( $\varepsilon = 10^{-4.0}$ ). While there is no formal variational principle in SeA, the  $E_{xx}$  values obtained for these aqueous systems tend to be variational, i.e.,  $E_{xx}^{SeA} \geq E_{xx}^{PWSCF(ACE)}$ , for larger  $\varepsilon$  values ( $\varepsilon =$  $10^{-3.0}$ ). Here, we would argue that the remaining (albeit small) systematic difference is largely due to pair selection (i.e., the exclusion of nonself pairs with small but finite  $S_{li,jl}$  values, cf. eq 17) and domain truncation (i.e., the use of system-sizeindependent domains  $\Omega_{ii} \subset \Omega$  in eq 16 to compute the  $E_{xx}$ contributions from both self- and nonself pairs). To maximize transferability, the recently extended version<sup>62</sup> of exxincorporated into SeA ensures that the pair selection error (governed by  $\delta$  in eq 17) is smaller than but comparable to the domain truncation error (governed by  $\varepsilon$  in eq 16). For tighter  $\varepsilon$  settings ( $\varepsilon = 10^{-3.5}$  and  $10^{-4.0}$ ), this residual difference is no longer systematic, which can be seen by comparing the MSD and mean absolute deviations (MAD) in Table 1. Quite interestingly, we also note that the differences in  $E_{xx}$  are essentially constant across this diverse set of nonequilibrium aqueous configurations for all  $\varepsilon$  settings—this is reflected by the flat distributions in Figure 3 as well as the nearly identical MAD and root-mean-square deviations (RMSD) in Table 1. This provides strong evidence that the current exx approach<sup>62</sup> is quite robust and able to operate at an *a priori* estimated level of accuracy (i.e., controllable error) set by  $\varepsilon$ . With  $E_{xx}$  deviations that are essentially flat across such a wide range of system densities, we also expect that SEA will be an <span id="page-10-0"></span><span id="page-10-0"></span>accurate and reliable tool for screening materials, sampling PES, and generating high-quality data for ML applications (*vide infra*).

As an additional assessment, we also considered the accuracy of the ionic forces (which are of central importance to MD simulations and ML data generation) obtained using SEA for this set of nonequilibrium aqueous configurations. As depicted in Figure 3 and Table 1, the use of successively smaller  $\varepsilon$  values again consistently reduces the RMSD in  $\{F_I\}$  between SEA and PWSCF (ACE) from 0.30 mHa/Bohr ( $\varepsilon = 10^{-3.0}$ ) to a visible plateau at 0.19 mHa/Bohr ( $\varepsilon = 10^{-3.5}$ ) and 0.16 mHa/ Bohr  $(\varepsilon = 10^{-4.0})$ . For reference, these residual force differences are negligible when compared to the magnitude of  $\{F_I\}$  in these systems (17.2  $\pm$  3.3 mHa/Bohr; see Table 1) and small relative to the typical convergence criterion used during structural relaxations of condensed-phase systems ( $\approx$ 1.0 mHa/Bohr). These small but observable residual differences between SeA ( $\varepsilon = 10^{-3.5}$  and  $10^{-4.0}$ ) and PWSCF (ACE) are largely due to finite-size effects<sup>80</sup> in the evaluation of exact exchange in periodic systems,<sup>21</sup> which lead to errors in both of these approaches; the relative convergence of  $E_{xx}$  and  $\{F_I\}$  in SEA and PWSCF (ACE) as a function of system size will be discussed in future work. With ionic force deviations that are essentially constant across such a wide range of system densities for all  $\varepsilon$  settings, we expect that SeA will reproduce the structure and dynamics of large-scale finite-gap systems with high fidelity during MD simulations at the hybrid DFT level. We also note in passing that the RMSD in  $\{F_I\}$  between SEA and PWSCF (ACE) is an order-of-magnitude ( $\approx 20 40\times$ ) smaller than the RMSD between PBE<sup>81</sup> (GGA) and PBE0 (i.e., 6.63 mHa/Bohr; see Table 1).

In Table 1, we also assessed the accuracy of SeA against PWSCF (ACE) when computing several other physical properties among this diverse set of aqueous configurations, namely, the valence bandwidth (VBW), binding energy  $(E_{\rm h})$ , and orbital eigenvalues  $(\{\lambda_i\})$ . As seen above for  $E_{xx}$  and  $\{F_I\}$ , all of these properties rapidly converge as  $\varepsilon$  is reduced from  $10^{-3.0}$  to  $10^{-3.5}$  and  $10^{-4.0}$ . For the VBW, the MAD were effectively negligible and ranged from 3 meV ( $\varepsilon = 10^{-4.0}$ ) to 11 meV ( $\varepsilon = 10^{-3.0}$ ). To put these results into context, such deviations are 3 orders of magnitude smaller than the typical VBW at the PBE0 level (21.9  $\pm$  0.7 eV) and 1–2 orders of magnitude smaller than the MAD between PBE and PBE0 (0.410 eV). For the individual orbital eigenvalues, the  $(MAD)_{200}$  (i.e., the population mean corresponding to the 200 MAD values) were also on the meV scale and ranged from 3 meV ( $\varepsilon = 10^{-4.0}$ ) to 15 meV ( $\varepsilon = 10^{-3.0}$ ). Similar to the VBW, these effectively negligible differences are 2-3 orders of magnitude smaller than the typical HOMO energy at the PBE0 level (-4.2  $\pm$  0.6 eV) and 1-2 orders of magnitude smaller than the MAD between PBE and PBE0 (0.521 eV). When computing  $E_{\rm b}$ , the MAD between SeA and PWSCF (ACE) ranges from 0.06 kcal/mol ( $\varepsilon = 10^{-4}$ ) to 0.28 kcal/mol ( $\varepsilon =$  $10^{-3}$ ) and is quite flat across these 200 snapshots. While SeA already provides  $E_b$  with effectively sub-kJ/mol accuracy (i.e., well within "chemical accuracy" of <1 kcal/mol), tighter  $\varepsilon$ values would be recommended when more stringent accuracy is needed (i.e., for very weakly bound systems).

### **III.B. Performance of SeA.** 
#### *III.B.1. Attacking the Bottleneck of PWSCF(ACE) with SeA.* 
Having assessed the accuracy of SeA against *PWSCF(ACE)* for a number of different properties across a diverse set of 200 nonequilibrium aqueous configurations, we now provide a preliminary analysis of the computational performance of the SeA implementation in the PWSCF module of QE. We will focus our discussion on the wall time associated with the ACE Construction step (see section II.D and Figure 2), i.e., the typical computational bottleneck during PWSCF (ACE) calculations of systems with sizes similar to  $(H_2O)_{64}$  (vide infra). As shown in Figure 3, SEA provides an order-of-magnitude speedup of  $\approx 60.4 \times (\varepsilon =$  $10^{-3.0}$ ),  $\approx 40.8 \times (\varepsilon = 10^{-3.5})$ , and  $\approx 24.3 \times (\varepsilon = 10^{-4.0})$  on average in the ACE Construction step for these 200 aqueous configurations. As expected, the observed speedup decreases when performing higher-accuracy SEA calculations with tighter  $\varepsilon$  values. As seen in eq 16, the use of tighter  $\varepsilon$ values corresponds to less aggressive domain truncation when determining the orbital-specific local domain  $(\Omega_{ii} \subset \Omega)$  that encompasses each  $\phi_i$ . Hence, larger  $\Omega_{ii}$  and  $\Omega_{ij} \equiv \Omega_{ii} \cap \Omega_{jj}$ domains will be used when computing the self  $(\langle ii \rangle)$  and nonself  $(\langle ij \rangle)$  contributions to  $E_{xx}$  with tighter  $\varepsilon$  values. Tighter  $\varepsilon$  values also correspond to less aggressive pair selection; hence, the number of  $\langle ij \rangle$  pairs will also be larger (see eq 17 and surrounding discussion), which further increases the computational cost.

In general, the speedups observed in Figure 3 are inversely correlated with the system density<sup>82</sup> for all  $\varepsilon$  settings; for simplicity, we will focus our discussion on the intermediate  $\varepsilon$  =  $10^{-3.5}$  setting (Figure 3 middle panel) throughout the remainder of the article. While the mean speedup in the PWSCF (ACE) computational bottleneck is  $\approx 40.8 \times$  using this setting, we observed a significantly larger (i.e., a two order-ofmagnitude) speedup of  $\approx 116 \times$  for the least dense configuration ( $d = 0.42 \text{ g/cm}^3$ ). Since less dense systems will have a smaller number of overlapping  $\langle ij \rangle$  pairs as well as smaller  $\Omega_{ii}$ domains, this result is not surprising and provides further evidence that the recently extended version<sup>62</sup> of exxincorporated into SeA is able to automatically exploit the increased degree of sparsity present in such systems. Even for the most dense configuration considered herein (which has significantly less sparsity and a system density of d = 1.66 g/ cm<sup>3</sup>), SeA still provides an order-of-magnitude speedup  $(\approx 11 \times)$  in the most computationally demanding ACE Construction step. By attacking the bottleneck of PWSCF-(ACE), SeA is therefore able to furnish highly accurate energies, ionic forces, and other physical properties at the hybrid DFT level at a significantly reduced computational cost for systems with sizes similar to (and beyond that of)  $(H_2O)_{64}$ .

#### III.B.2. Detailed Computational Analysis of SeA. 
Having assessed the accuracy and preliminary performance of SEA against PWSCF (ACE) on the 200 nonequilibrium aqueous configurations in Figure 3, we now provide a more detailed analysis of the computational cost associated with each procedural component in these two approaches (i.e., each function call in Algorithm 1 and Figure 2). To do so, we consider the wall time associated with EXX-SCF calculations at the PBEO level with SEA and PWSCF (ACE) for three (H<sub>2</sub>O)<sub>64</sub> configurations of varying system densities taken from this set: the most dense configuration ( $d = 1.66 \text{ g/cm}^3$ ), a representative configuration with ambient density (d = 0.99 g/ cm<sup>3</sup>), and the least dense configuration ( $d = 0.42 \text{ g/cm}^3$ ). Each EXX-SCF calculation was started from converged PBE orbitals that were stored on disk; the wall times associated with generating these initial orbitals were excluded from the current analysis and will be included when discussing the overall timeto-solution in section III.B.3. As reported in Table 2, each PBE0 calculation required 5 ACE\_Construction (outerloop) steps and 13-14 SCF\_Iteration (inner-loop) steps (cf. Algorithm 1). When using PWSCF (ACE) to perform these PBE0 calculations, a similar picture is observed for all three (H<sub>2</sub>O)<sub>64</sub> configurations: the overall wall time in each case was dominated by the ACE\_Construction step (96.9-97.9% of the overall wall time) with the (negligible) remaining time spent in SCF\_Iteration. During the ACE\_Construction step in PWSCF (ACE) — the computational bottleneck for systems with sizes similar to  $(H_2O)_{64}$  calculation of the targeted  $\{D_{xx}^i(G)\}$  via the vexx function (Figure 2a) accounted for the lion's share of the cost (96.8-97.9% of the overall wall time) while the construction of  $\hat{V}_{xx}^{ACE}$ via decomp (Figure 2c) was largely negligible ( $\leq 0.1\%$ ).
      
<span id="page-11-0"></span><span id="page-11-0"></span>Table 2. Detailed Wall Time Breakdown for EXX-SCF Calculations at the PBE0 Level Using PWSCF (ACE) and the SeA ( $\varepsilon = 10^{-3.5}$ ) Implementation in the PWSCF Module of QE for Three Selected  $(H_2O)_{64}$  Configurations (with System Densities Ranging from Most Dense to Least Dense) Taken from the Set of 200 Nonequilibrium Aqueous Configurations Considered in Figure  $3^a$ 

|                              |                  |                  |           | Most Dense         |       |                  | Ambient Density    |       |                  | Least Dense        |       |                  |  |  |
|------------------------------|------------------|------------------|-----------|--------------------|-------|------------------|--------------------|-------|------------------|--------------------|-------|------------------|--|--|
| System Density $\rightarrow$ |                  |                  |           | $(d = 1.66 g/cm3)$ |       |                  | $(d = 0.99 g/cm3)$ |       |                  | $(d = 0.42 g/cm3)$ |       |                  |  |  |
| Level                        | Method           | Stepb            | Functionb | Time<br>(s/call)   | Calls | Relative<br>Cost | Time<br>(s/call)   | Calls | Relative<br>Cost | Time<br>(s/call)   | Calls | Relative<br>Cost |  |  |
| PBE0                         | PWSCF (ACE)      | ACE_Construction | vexx      | 227.5              | 5     | 96.8%            | 478.3              | 5     | 97.5%            | 1, 798.0           | 5     | 97.9%            |  |  |
|                              |                  |                  | decomp    | 0.1                | 5     | 0.1%             | 0.2                | 5     | 0.0%             | 0.4                | 5     | 0.0%             |  |  |
|                              |                  | SCF_Iteration    | -         | 2.9                | 13    | 3.1%             | 4.7                | 13    | 2.5%             | 13.8               | 14    | 2.1%             |  |  |
| PBE0                         | SeA $(10^{-15})$ | ACE_Construction | SCDM      | 2.7                | 5     | 9.7%             | 4.4                | 5     | 17.4%            | 10.4               | 5     | 19.2%            |  |  |
|                              |                  |                  | exx       | 17.2               | 5     | 62.3%            | 8.3                | 5     | 32.7%            | 4.1                | 5     | 7.6%             |  |  |
|                              |                  |                  | rot_D     | 0.2                | 5     | 0.6%             | 0.3                | 5     | 1.1%             | 0.6                | 5     | 1.1%             |  |  |
|                              |                  |                  | decomp    | 0.1                | 5     | 0.4%             | 0.2                | 5     | 0.7%             | 0.4                | 5     | 0.7%             |  |  |
|                              |                  | SCF_Iteration    | -         | 2.9                | 13    | 27.0%            | 4.7                | 13    | 48.1%            | 13.8               | 14    | 71.4%            |  |  |
| Speedupc                     |                  |                  |           |                    |       |                  |                    | 36.1x |                  |                    |       | 116.0x           |  |  |

speedup

"Each calculation was performed using a single Cori-Haswell node (with 16 MPI processes and 4 OpenMP threads per process) starting from converged orbitals at the PBE level; the number of SCF iterations performed during these preliminary PBE calculations was excluded from the number of calls to SCF\_Iteration. <sup>b</sup>See Algorithm 1 and Figure 2. <sup>c</sup>Following the convention used in Figure 3, the speedup was computed as the ratio of the total wall time spent in the ACE\_Construction step in PWSCF (ACE) vs SeA.

Table 3. Overall Time-to-Solution for SCF Calculations at the PBE and PBE0 Levels for Three Selected  $(H_2O)_{64}$ Configurations (with System Densities Ranging from Most Dense to Least Dense) Taken from the Set of 200 Nonequilibrium Aqueous Configurations Considered in Figure 3<sup>*a*</sup>

| System Density $\rightarrow$ |              | Most Dense (d = 1.66 g/cm3) |               |               | Ambient Density (d = 0.99 g/cm3) |               |               | Least Dense (d = 0.42 g/cm3) |               |               |
|------------------------------|--------------|-----------------------------|---------------|---------------|----------------------------------|---------------|---------------|------------------------------|---------------|---------------|
| Level                        | Method (M)   | $t_M$ (s)                   | $t_M/t_{PBE}$ | $t_M/t_{SeA}$ | $t_M$ (s)                        | $t_M/t_{PBE}$ | $t_M/t_{SeA}$ | $t_M$ (s)                    | $t_M/t_{PBE}$ | $t_M/t_{SeA}$ |
| PBE                          | PWSCF        | 16                          | 1.0           | 0.1           | 23                               | 1.0           | 0.2           | 89                           | 1.0           | 0.3           |
| PBE0                         | SeA (10-3.5) | 154                         | 9.6           | 1.0           | 151                              | 6.6           | 1.0           | 360                          | 4.0           | 1.0           |
|                              | PWSCF (ACE)  | 1, 191                      | 74.4          | 7.7           | 2, 477                           | 107.7         | 16.4          | 9, 274                       | 104.2         | 25.8          |
|                              | PWSCF (FULL) | 12, 012                     | 750.8         | 78.0          | 25, 027                          | 1, 088.1      | 165.7         | 89, 050                      | 1, 000.6      | 247.4         |

"Each calculation was performed using a single Cori-Haswell node (with 16 MPI processes and 4 OpenMP threads per process) with corresponding wall times for each method  $(t_M)$  reported in seconds. PBE0 calculations were performed using the SeA ( $\varepsilon = 10^{-3.5}$ ), PWSCF (ACE), and PWSCF (FULL) methods starting from converged orbitals at the PBE level; in all three cases, the reported  $t_M$  values include the initial wall time needed to obtain the PBE orbitals. To enable a straightforward comparison between methods, we also report the relative speedup of PBE ( $t_M/t_{PBE}$ ) and SeA ( $t_M/t_{SeA}$ ) with respect to each method M.

As mentioned above, SeA harnesses computational savings from domain truncation and pair selection to provide a 1-2order-of-magnitude speedup (11.3-116.0×) in the bottleneck ACE\_Construction step for these three  $(H_2O)_{64}$ configurations (see Figure 3 and Table 2). Interestingly, this speedup is significant enough to *displace* the computational bottleneck in ACE-based PBE0 calculations from the ACE\_Construction step to the SCF\_Iteration step. This can be seen by considering the ACE\_Construction : SCF Iteration relative cost ratio (obtained from the data in Table 2), which is 73.0% : 27.0% for the most dense case, 51.9% : 48.1% for the ambient case, and 28.6% : 71.4% for the least dense case. In the least dense case, the increased cost of the inner-loop SCF\_Iteration step in SeA is largely due to the increased number of planewaves  $(N_{\rm pw})$  and grid points  $(N_{\rm FFT})$  as the simulation cell increases. Hence, the crossover from ACE\_Construction to SCF\_Iteration roughly occurs for  $(H_2O)_{64}$  configurations with the ambient system density when performing hybrid DFT calculations using SeA. This observation emphasizes the need for scalable and efficient GGA-based KS-DFT algorithms to reduce the cost of the SCF\_Iteration step in SeA and further extend the range of applicability of hybrid DFT.

Within the ACE\_Construction step in SeA, the SCDM and exx functions account for most of the cost: 9.7% + 62.3%= 72.0% (out of 73.0%) for the most dense case, 17.4% + 32.7% = 50.1% (out of 51.9%) for the ambient case, and 19.2% + 7.6% = 26.8% (out of 28.6%) for the least dense case. From this data, one can see that the wall times associated with these two functions have an opposite dependence on the system density, which leads to nonmonotonic changes in the ACE\_Construction wall time: 20.2 s/call for the most dense case, 13.2 s/call for the ambient case, and 15.5 s/call for the least dense case. On the one hand, the wall time spent in exx decreases monotonically with decreasing density from <span id="page-12-0"></span><span id="page-12-0"></span>17.2 s/call (most dense case) to 8.3 s/call (ambient density) to 4.1 s/call (least dense case), due to the increasing degree of sparsity as d decreases (see section III.B.1).<sup>82</sup> On the other hand, the  $O(N_{\text{FFT}}^{\text{wf}}N_{\text{occ}}^2 + N_{\text{occ}}^3)$  cost of SCDM in SeA (see section II.D) increases monotonically with decreasing density from 2.7 s/call (most dense case) to 4.4 s/call (ambient density) to 10.4 s/call (least dense case), due to the increasing number of real-space grid points  $(N_{\text{FFT}}^{\text{wf}})$  as d decreases. While the cost of SCDM is comparable to exx for these  $\left(H_2O\right)_{64}$ systems, the SCDM cost will grow more quickly (cubically) with system size than exx (linear); hence, a more efficient SCDM localization algorithm will become crucial when applying SeA to larger systems and is currently under active development in our group. While the costs associated with rot D and decomp remain small compared to exx for  $(H_2O)_{64}$ , both of these routines also scale cubically with system size (but with markedly smaller prefactors than SCDM) and will therefore become more important for substantially larger systems.

#### III.B.3. High-Throughput Time-to-Solution with SeA. 
To showcase the throughput of SeA, we now compare the overall time-to-solution when performing EXX-SCF calculations at the PBEO level using SeA, PWSCF (ACE), and PWSCF (FULL) (i.e., the conventional convolution-based (non-ACE) EXX approach) on the three  $(H_2O)_{64}$  configurations of varying system densities discussed above in section III.B.2. Each of these PBE0 calculations was started from converged PBE orbitals stored on disk; the wall times associated with generating these initial orbitals are reported in Table 3 and are also included in the overall time-to-solution for each of these methods. As depicted in Table 3, SeA can complete each of these PBE0 calculations within a few minutes on a single Cori-Haswell node: 154 s (most dense case), 151 s (ambient density), and 360 s (least dense case)—timings which are only  $4.0-9.6\times$  the cost of the analogous PBE calculation. In contrast, PWSCF (ACE) takes approximately 0.3-2.6 h for the same set of calculations, while the conventional convolutionbased (non-ACE) EXX implementation (PWSCF (FULL)) spent a little more than a day (89,050 s) on the least dense  $(H_2O)_{64}$  configuration. Hence, SeA provides an order-ofmagnitude speedup in the overall time-to-solution (7.7-25.8×) compared to PWSCF (ACE) and a 1-2 order-ofmagnitude speedup  $(78.0-247.4\times)$  when compared to PWSCF (FULL).

We also compared the performance of the SeA implementation in the PWSCF module of QE against the original exx implementation<sup>47,49</sup> in the CP module as well as the L-ACE approach<sup>43</sup> in the PWSCF module when performing the same PBE0 calculations. When comparing against the MLWF-based exx implementation in CP (which harnesses only two levels of computational savings), we used the computational settings described in ref 47. In this case, we had to use six Cori-Haswell nodes due to memory requirements (which have been significantly reduced by using the appropriate planewave resolution in SeA; see section II.D) and found that SEA provides an order-of-magnitude speedup  $(\approx 20-40\times)$  in the overall time-to-solution. We attribute this large speedup to: (i) the extended version of exx used in SeA (which has been updated/optimized since refs 47 and 49); (ii) the third level of computational savings provided by the ACE operator in SeA; and (iii) the more efficient SCF mixing algorithm in PWSCF (vs the damped dynamics scheme in CP). When comparing against L-ACE, all calculations were performed within a single Cori-Haswell node; here, we followed ref 43 and used the  $S_{thr} = 0.004$  localization threshold (i.e., L-ACE(0.004)). In doing so, we observed that SeA provides an  $\approx 5-9\times$  speedup in the overall time-to-solution compared to L-ACE(0.004). Although the following setting was not recommended by the developers of L-ACE, we also considered  $S_{thr} = 0.007-0.010$  (which provides comparable accuracy to SeA with  $\varepsilon = 10^{-3.5}$ ) as another point for comparison. Here, we found that SeA provides an  $\approx 4-7\times$ speedup, which is quite similar to that found when using L-ACE(0.004). These speedups mostly originate from the additional level of computational savings (domain truncation) harnessed by SeA; as such, even greater speedups are expected for larger and/or more sparse systems.

## IV. PROOF-OF-PRINCIPLE HIGH-THROUGHPUT APPLICATION: TRAINING A HYBRID DFT-BASED DNN MODEL FOR LIQUID WATER WITH Sea

As a proof-of-principle high-throughput application, we now demonstrate how SeA can be used to efficiently train a converged deep neural network (DNN) potential for ambient (T = 300 K, p = 1 bar) liquid water at the PBE0<sup>64,65</sup> level via the deep potential molecular dynamics (DPMD) active-learning protocol of Car, E, and co-workers<sup>83,84</sup> (section IV.A). We then assess the accuracy of this SeA-trained DNN potential on an out-of-sample test set containing several elevated-temperature ( $H_2O$ )<sub>512</sub> snapshots in section IV.B, and showcase the capabilities of SeA by directly computing the (ground-truth) ionic forces in these challenging systems containing >1,500 atoms.

### IV.A. Convergence and Precision of the Model. 
Having assessed the accuracy and performance of SeA on a diverse set of 200 nonequilibrium  $(H_2O)_{64}$  configurations (which include both intact and autoionized water molecules, and densities spanning  $0.4-1.7 \text{ g/cm}^3$  collected during the active learning of a DNN potential for water at the meta-GGA (SCAN) level,<sup>70,71</sup> we now proceed to label (i.e., compute energies and ionic forces for) all 8,610 configurations in this collection at the hybrid (PBE0) DFT level using SeA ( $\varepsilon = 10^{-3.5}$ ); see Appendix C for computational details regarding the electronic structure calculations. Based on this initial data set, we then trained a DNN for ambient liquid water (T = 300 K, p = 1 bar) following the DPMD active-learning procedure outlined in refs 83 and 84 (see Appendix D for training details). Hence, the progress of our active-learning protocol was monitored by the model deviation ( $\mathcal{E}$ ) in the ionic forces { $F_1$ }:

$$\mathcal{E} \equiv \max_{I} \sqrt{\langle |\mathbf{F}_{I} - \langle \mathbf{F}_{I} \rangle |^{2} \rangle}$$
(21)

in which the max function was taken over all ions I, and the averages (denoted by  $\langle \cdots \rangle$ ) were evaluated over an ensemble of four independently trained DNN models (i.e., trained using the same data but different initial random seeds) for each snapshot in a given trajectory. From this expression, one can see that  $\mathcal{E}$  is a precision-based criterion that is measured among equivalently trained DNN models; an accuracy-based assessment, in which the ionic forces from the final DNN model(s) are directly compared to the ground-truth PBE0 ionic forces, will be provided in section IV.B. For the trajectory needed in eq 21, we performed a DPMD simulation (i.e., a classical MD simulation propagated using one of the trained DNN models as the underlying force field) in the NpT <span id="page-13-0"></span><span id="page-13-0"></span>ensemble (*T* = 300 K, *p* = 1 bar); see [Appendix](#page-16-0) D for more details. When configurations with large model deviations (i.e., > 2.0 mHa/Bohr) were encountered, these configurations were relabeled with SeA and added to the training set for the next round of active learning (i.e., DPMD exploration and configuration selection/relabeling). The active-learning process was stopped when the 90th percentile of the probability density function (*P*( )) was below 1.0 mHa/Bohr, a typical convergence criterion used during structural relaxation in condensed-phase systems.

Doing so leads to a total of two active-learning iterations across a total of 8,705 (H2O)64 configurations (i.e., yielding 95 additional configurations not contained in the initial training set). As shown in Figure 4, the final *P*( ) at *T* = 300 K and *p* = 1 bar (i.e., the thermodynamic conditions used during training) meets the convergence criterion outlined above and therefore depicts a converged DNN potential for ambient liquid water at the PBE0 level. As an additional assessment of the precision in our SeA-trained DNN model, we also performed DPMD simulations (using the DNN potential trained at *T* = 300 K and 1 bar) in the *NpT* ensemble at 270, 330, and 360 K. As expected, we find that tends to increase with *T* in Figure 4, as the additional thermal energy causes the system to explore larger sectors of configuration space which were sampled less thoroughly by the active-learning process at 300 K. However, the trained DNN model still remains quite precise with relatively smooth/continuous *P*( ) distributions�the bulk of which are still below the desired 1.0 mHa/Bohr threshold�even at such elevated temperatures. While *P*( ) can be further improved by performing additional active-learning steps, this is beyond the scope of this proof-ofprinciple high-throughput application, which illustrates the utility of SeA for training DNN potentials for large-scale finitegap systems at the hybrid DFT level.

Image /page/13/Figure/3 description: The figure shows a plot of probability P(E) versus E, where E is defined as max\_I sqrt(| - ^2|) (mHa/Bohr). There are four curves plotted on the same axes, corresponding to different temperatures at 1 Bar. The curves are labeled as follows: 270 K (dashed black), 300 K (solid blue, training), 330 K (dashed green), and 360 K (dashed red). The x-axis ranges from 0.5 to 2.0, and the y-axis ranges from 0 to 5. The curves show the probability distribution of E at different temperatures.

Figure 4. Normalized probability density functions of the model deviation (*P*( )) in the ionic forces ({*FI*}) across four independently trained DNN models of liquid water at *T* = 300 K and *p* = 1 bar (solid blue line, training thermodynamic conditions); training protocol = active learning of PBE0 ionic forces computed with SeA (*ε* = 10<sup>−</sup>3.5) in 8,705 (H2O)64 configurations. Also depicted are *P*( ) for the following out-of-sample thermodynamic conditions: *T* ∈ {270 K, 330 K, 360 K} and *p* = 1 bar (dashed lines). In each case, was evaluated over a DPMD trajectory of (H2O)64 at the corresponding thermodynamic conditions; all averages were evaluated over the ensemble of four DNN models and denoted by ⟨···⟩. Figure 5. Correlation plot between DNN ionic force components

### **IV.B. Accuracy of the Model: Out-of-Sample Testing and a Beyond-One-Thousand-Atom Challenge.** 
To assess the accuracy of this SeA-trained DNN model, we also compared its ionic force predictions against the ground truth (i.e., direct ionic force calculations at the PBE0 level using SeA with *ε* = 10<sup>−</sup>3.5). As an initial assessment, we considered 16 equispaced (H2O)64 snapshots from the *NpT* DPMD simulation performed in [section](#page-12-0) IV.A at *T* = 300 K and 1 bar (i.e., the training/active-learning thermodynamic conditions). When compared against direct ionic force calculations with SeA, we found that the ionic forces furnished by the final DNN model(s) were highly accurate with a root-mean-square error (RMSE) of 0.75 mHa/Bohr. For a more stringent assessment, we prepared an out-of-sample test set, which included two equispaced snapshots from a ≈1 ns DPMD simulation of (H2O)512 at *T* = 330 K and 1 bar (using the DNN potential trained on (H2O)64 at *T* = 300 K and 1 bar). Using these uncorrelated snapshots, we again found that the ionic forces provided by the DNN model(s) were able to reproduce the ground-truth ionic forces with very high fidelity (Figure 5). As depicted in this figure, the RMSE for this test set (which is out-of-sample in both system size and *T*) was 0.90 mHa/Bohr, which is only slightly larger than the RMSE found above for the (H2O)64 snapshots collected at the training/ active-learning thermodynamic conditions. We attribute this (rather small) RMSE increase to the additional structural disorder afforded by the extended system size ((H2O)64 → (H2O)512) and elevated temperature (300 K → 330 K) in this out-of-sample test set. Here, we also note that both RMSE values are below typical force convergence thresholds (∼1.0 mHa/Bohr), which further highlights the high degree of accuracy achieved by this SeA-trained DNN model. While direct AIMD simulations of liquid water at the PBE0 level have been reported (e.g., ref 33), there are a number of differences between those simulations and the DNN-based simulations performed herein (e.g., Car-Parrinello vs Born-Oppenheimer, simulation lengths, NpT vs NVT, etc.) which hinder a quantitative comparison of the resultant structural/ equilibrium properties (e.g., radial distribution functions) as an additional assessment of the accuracy of our SeA-trained DNN model. In the same breath, the development of the highthroughput SeA framework in this work enables a more thorough investigation of such issues, which will be addressed in future work.

Image /page/13/Figure/10 description: The image is a scatter plot comparing DNN Forces and DFT Forces, both measured in mHa/Bohr. The plot is titled "Out-of-Sample: (H2O)512 @ 330 K" and includes the text "RMSE = 0.90 mHa/Bohr". The x-axis represents DFT Forces, and the y-axis represents DNN Forces. The data points are clustered tightly around a diagonal line, indicating a strong correlation between the two force measurements. The x and y axes range from -80 to 80. In the lower right corner of the plot, there is an inset image showing a 3D representation of (H2O)512.

(training set: 8,705 (H2O)64 configurations actively learned at *T* = 300 K and *p* = 1 bar) and ground-truth PBE0 ionic force components (computed using SeA (*ε* = 10<sup>−</sup>3.5)) for an out-of-sample test set containing two uncorrelated snapshots from a DPMD simulation of (H2O)512 at *T* = 330 K and *p* = 1 bar. DNN ionic force components are plotted as blue dots (with error bars based on the mean and standard deviation among the four independently trained DNN models); the red line indicates perfect correlation with the groundtruth PBE0 ionic force components.

Besides validating the accuracy of our SeA-trained DNN model, direct calculations of the ionic forces in these two (H<sub>2</sub>O)<sub>512</sub> snapshots (each containing >1,500 atoms) using SEA also highlight the capabilities of this approach when performing hybrid DFT calculations on large-scale condensedphase systems. For such challenging systems (which are currently beyond the reach of PWSCF(ACE)), SEA has enabled fully self-consistent calculations of their energies and ionic forces at the hybrid DFT level in ≈1.2 h using 25 Cori-Haswell nodes (with a total of 100 MPI processes and 16 OpenMP threads per MPI process). By performing such calculations with SeA, the overall cost is now dominated by the inner-loop SCF Iteration step instead of the outerloop ACE Construction step-the typical bottleneck in PWSCF (ACE) for large-scale systems. By harnessing three levels of computational savings, SeA has effectively removed the computational bottleneck that typically prohibits the routine use of hybrid DFT in high-throughput applications for systems like  $(H_2O)_{64}$  (cf. Tables 2 and 3) and beyond, e.g.,  $(H_2O)_{512}$ . This observation again reiterates the need for scalable and efficient GGA-based KS-DFT algorithms (e.g., linear-scaling and/or real-space approaches) which could reduce the cost of the inner-loop SCF Iteration step in SEA and thereby enable hybrid DFT calculations for significantly larger systems.

## V. CONCLUSIONS

In this work, we have developed SeA (SeA = SCDM + exx + ACE)—a robust, accurate, and computationally efficient framework for performing high-throughput hybrid DFT calculations on large-scale finite-gap systems. Implemented in the PWSCF module of Quantum ESPRESSO (QE), SeA combines and seamlessly integrates: (i) the selected columns of the density matrix (SCDM) approach<sup>35</sup> (a direct/noniterative orbital localization scheme that sidesteps the need for system-dependent optimization protocols); (ii) a recently extended black-box version<sup>62</sup> of  $e \times x^{47,49}$  (a linear-scaling realspace EXX algorithm that exploits the sparsity between localized orbitals when evaluating the action of the standard/ full-rank EXX operator  $(\hat{V}_{xx})$ ; and (*iii*) the adaptively compressed exchange (ACE)<sup>36</sup> formalism (an efficient lowrank  $V_{xx}$  approximation that reduces the number of full-rank evaluations of the action during the iterative EXX-SCF procedure). By construction, SeA is able to harness three distinct levels of computational savings during hybrid DFT calculations: two from SCDM + exx (pair selection and domain truncation: as this approach only considers spatially overlapping orbital pairs and evaluates their corresponding EXX interaction on orbital-pair-specific/system-size-independent real-space domains) and one from ACE (low-rank  $\hat{V}_{xx}$ approximation: which reduces the number of SCDM + exx calls during the SCF solution to the KS-DFT equations). To assess the accuracy and performance of SeA, we compared this approach against PWSCF (ACE) (the convolution-based ACE) implementation in the PWSCF module of QE) across a diverse set of 200 nonequilibrium  $(H_2O)_{64}$  configurations (which include both intact and autoionized water molecules, and have system densities ranging from  $\approx 0.4$  to  $\approx 1.7$  g/cm<sup>3</sup>). In doing so, we found that SeA furnishes a 1-2 order-of-magnitude speedup ( $\approx 11-116\times$ ) in the computational bottleneck ACE Construction step in PWSCF(ACE), while reproducing the EXX energy and ionic forces with high fidelity (i.e., mean  $E_{xx}$  differences of  $\approx 10^{-3}$ % and RMSD in  $\{F_I\}$  of  $\approx 0.2$  mHa/Bohr). Hence, SeA effectively removes the computational bottleneck that typically prohibits the routine use of hybrid DFT in high-throughput applications involving systems with sizes similar to (and beyond that of)  $(H_2O)_{64}$  and enables single-point energy and ionic force evaluations for such systems with an order-of-magnitude speedup  $(8-26\times)$  in the overall time-to-solution compared to PWSCF (ACE) and a 1-2 order-of-magnitude speedup  $(78-247\times)$  in the overall timeto-solution compared to PWSCF (FULL), the conventional (non-ACE) convolution-based EXX implementation. With ionic force errors that are lower than typical convergence thresholds used during the structural relaxation of condensedphase systems (e.g., 1.0 mHa/Bohr) and order(s)-ofmagnitude performance improvements, SeA paves the way toward the routine use of hybrid DFT in large-scale highthroughput applications such as materials screening and discovery, PES sampling, and quantum mechanical data generation for ML.

As a proof-of-principle high-throughput application, we used SEA to train a deep neural network (DNN) potential for ambient (T = 300 K, p = 1 bar) liquid water at the PBE0 level, based on an actively learned data set containing ≈8,700  $(H_2O)_{64}$  configurations. The convergence/precision of this SeA-trained DNN model was demonstrated by small model deviations in the ionic forces for liquid water under ambient (T= 300 K, p = 1 bar) and nonambient/out-of-sample ( $T \in \{270\}$ K, 330 K, 360 K}, p = 1 bar) thermodynamic conditions. By comparing the DNN ionic force predictions to the ground truth (direct PBE0 calculations using SeA) for a challenging out-of-sample test set  $((H_2O)_{512}$  at T = 330 K, p = 1 bar), we also found that the SeA-trained DNN model was highly accurate with an RMSE of 0.90 mHa/Bohr in the ionic force components. This ground-truth comparison not only validated the accuracy of the DNN model but also showcased the capabilities of SeA to perform hybrid DFT calculations for condensed-phase systems containing >1,500 atoms.

## VI. FUTURE OUTLOOK

While SeA in its current form already provides a robust, accurate, and computationally efficient framework for performing high-throughput condensed-phase hybrid DFT calculations on large-scale finite-gap systems, there still remains room for further improvement. In particular, we are actively working on the following research thrusts to enhance the features and capabilities of SeA: (*i*) support for general Monkhorst–Pack (i.e., beyond  $\Gamma$ -point) Brillouin zone sampling; (*ii*) an extension to range-separated hybrid (RSH) functionals;<sup>85–91</sup> and (*iii*) the development of a consistent SeA algorithm for implementation in real-space codes. We are also actively working to further improve the overall efficiency of SeA (by enabling GPU support and reducing the prefactor/scaling in the SCDM orbital localization scheme) and finalizing a public release of SeA in the PWSCF module of QE. We have also completely overhauled the exx codebase with a comprehensive three-pronged algorithmic strategy designed to increase computational efficiency, decrease communication overhead, and minimize processor idling; to maximize the impact of these developments, we are also working on the public release of this EXX engine as a standalone free software library (exx1).

Here, we would also emphasize that the applicability of SEA extends beyond high-throughput EXX-SCF calculations (i.e., single-point energy and ionic force evaluations) at the hybrid DFT level. For instance, SeA (in its current form) can be used to accelerate Born-Oppenheimer AIMD (BOMD) simulations (to a significantly larger degree than the original implementation of  $\exp^{47,49}$  in the CP module of QE due to the additional computational savings from the ACE operator) and also has the potential to increase the length- and timescales accessible by AIMD (both CPMD and BOMD) when used in conjunction with the multiple time scale approach<sup>63,92</sup> based on the ACE operator.<sup>45,48,93</sup> Due to the continuous time evolution of the trajectory during AIMD simulations, SeA is not restricted to SCDM orbitals and could also be used in conjunction with other localization schemes (e.g., MLWFs<sup>50,51</sup>) by keeping track of (and continuously refining<sup>53</sup>) the unitary operator connecting the local and canonical representations of the occupied space. When performing hybrid DFT-based CPMD, a gauge-invariant sampling can be achieved using the field-theoretic approach proposed by Tuckerman and co-workers94 or direct propagation in the canonical orbital representation while evaluating all EXX-related quantities in the localized orbital representation (i.e., akin to what was done for SEA in this work). Although not explicitly described in this work, the current version of SEA computes the EXX contribution to the cell forces/stress tensor (i.e.,  $\sigma_{xx}$ ) in real space via  $\exp^{49}$  and can therefore be used to perform constant-pressure calculations at the hybrid DFT level (e.g., variable cell relaxations and NpH/NpT simulations) as well. Since the real-space evaluation of  $\sigma_{xx}$  is subject to small (but non-negligible) aliasing errors when performed in a planewave code, we are also working on an extension to SEA that will compute this quantity directly from  $\hat{V}_{\rm xx}^{\rm ACE}$  (in analogy to the evaluation of  $E_{\rm xx}$ currently done in SEA via eq 19).

### APPENDIX A: ALTERNATIVE ACE DECOMPOSITION SCHEME FOR APPROXIMATE EXX CALCULATIONS

During the ACE Construction step, an approximate evaluation of  $\{D_{xx}^{i}\}$  can lead to a nonsymmetric and/or nonpositive-semidefinite M matrix (with elements  $M_{ij} \equiv \langle \phi_i | D_{xx}^j \rangle = -\langle \phi_i | \hat{V}_{xx} | \phi_j \rangle$ ), making this matrix unsuitable for Cholesky decomposition in the subsequent decomp function (see eq 18 and surrounding discussion). Here, we remind the reader that the use of  $|D_{xx}^i\rangle$  instead of  $\hat{V}_{xx} | \phi_i \rangle$  leads to a sign difference in  $M_{ij}$  when compared to Lin's original formulation.<sup>36</sup> To fulfill the symmetry requirement, we symmetrize M via  $\overline{M} \equiv \frac{1}{2}(M + M^T)$  to remove the (albeit small) skew-symmetric contributions arising from the approximate evaluation of  $\{D_{xx}^i\}$ ; this approach has also been used in the L-ACE approach.<sup>43</sup> For the  $\approx$ 8,700 aqueous configurations  $((H_2O)_{64} \text{ and } (H_2O)_{512})$  considered in this work, symmetrization of M was sufficient to allow for Cholesky decomposition to proceed without issue (i.e.,  $\overline{M}$  remained positive-semidefinite in all of these cases). However, Cholesky decomposition will fail if the approximate evaluation of  $\{D_{xx}^i\}$  violates the positive-semidefiniteness requirement on  $\overline{M}$ ; in SeA, this issue can arise when using loose  $\varepsilon$  settings and/or treating systems with more substantial finite-size effects (i.e., systems with highly delocalized orbitals relative to the size of the unit cell).

To improve the robustness of SeA, we therefore implemented an alternative/generalized low-rank decomposition routine based on the following eigen-decomposition of the real symmetric  $\overline{M}$  matrix:

$$\overline{\mathbf{M}} = \mathbf{Q} \mathbf{\Lambda} \mathbf{Q}^{T} = (\mathbf{Q} \mathbf{\Lambda}^{1/2}) (\mathbf{\Lambda}^{1/2} \mathbf{Q}^{T}) \equiv \mathbf{Z} \mathbf{Z}^{T}$$
(A1)

in which Q is an  $N_{\rm occ} \times N_{\rm occ}$  orthogonal eigenvector matrix (not to be confused with the orthogonal matrix in the SCDM QR factorization in eq 1),  $\Lambda$  is the corresponding  $N_{\rm occ} \times N_{\rm occ}$ diagonal eigenvalue matrix, and Z is an  $N_{\rm occ} \times N_{\rm occ}$  matrix alternative to the Cholesky factor (L). When constructed from the *exact*  $\{D_{xx}^i\}$ , the eigenvalues in  $\Lambda$  would be real and nonnegative, and hence  $\Lambda^{1/2}$  would be real. When constructed from an approximate  $\{D_{xx}^i\}$ ,  $\overline{M}$  is no longer guaranteed to be positive-semidefinite; in this case, the eigenvalues in  $\Lambda$  will be real but not necessarily non-negative; hence,  $\Lambda^{1/2}$  (and Z) can be complex. In this alternative scheme, the analogous ACE operator can be constructed as follows:

$$\hat{V}_{xx}^{ACE} = -\sum_{k} |\zeta_{k}\rangle\langle\zeta_{k}| \tag{A2}$$

in which

$$|\zeta_k\rangle \equiv -\sum_i |D_{xx}^i\rangle (\mathbf{Z}^{-T})_{ik}$$
(A3)

Equation A2 is the analogue of eq 18 with  $|\xi_k\rangle$  replaced by  $|\zeta_k\rangle$ ; since both of these quantities are complex-valued (as  $\{D_{xx}^i(G)\}\)$  is complex), no downstream changes in the code are needed to implement this alternative decomposition scheme. In this approach,  $Z^{-T}$  can be conveniently computed as

$$\boldsymbol{Z}^{-T} = (\boldsymbol{Q}\boldsymbol{\Lambda}^{1/2})^{-T} = \boldsymbol{Q}\boldsymbol{\Lambda}^{-1/2}$$
(A4)

since **Q** is orthogonal  $(\mathbf{Q}^T = \mathbf{Q}^{-1})$  and  $\Lambda$  is diagonal. In practice, we have found that this alternative decomposition scheme is quite robust across a broad range of systems; as such, it would be interesting to see if this approach also increases the robustness of other approximate ACE-based methods.<sup>43,48</sup>

#### APPENDIX B: OUTER-LOOP CONVERGENCE IN SEA VIA SUCCESSIVE IDEMPOTENCY

SCF convergence in SeA is measured at the *n*th outer-loop step (see Algorithm 1) via successive idempotency, i.e., the change in idempotency between density matrices at the current  $(\hat{P}^{(n)})$  and previous  $(\hat{P}^{(n-1)})$  steps:

<span id="page-16-0"></span><span id="page-16-0"></span>
$$\Delta I^{(n)} \equiv 1 - \frac{\mathrm{Tr}[\hat{P}^{(n)}\hat{P}^{(n-1)}]}{\mathrm{Tr}[\hat{P}^{(n)}\hat{P}^{(n)}]}$$
$$= 1 - \frac{\sum_{ij} |\langle \phi_i^{(n)} | \phi_j^{(n-1)} \rangle|^2}{N_{\mathrm{occ}}}$$
(B1)

in which  $\{|\phi_i^{(n)}\rangle\}$  is the set of proto-KS orbitals generated at the end of the nth outer-loop step (i.e., the self-consistent orbitals obtained using the fixed  $\hat{V}_{\rm xx}^{\rm ACE}$  at this step). For the  $\approx$ 8,700 aqueous configurations ((H<sub>2</sub>O)<sub>64</sub> and (H<sub>2</sub>O)<sub>512</sub>) considered in this work, we used  $10^{-7}$  as the outer-loop convergence criterion, i.e., the EXX-SCF procedure in SeA was considered converged when  $\Delta I^{(n)} \leq 10^{-7}$ . With the use of this setting,  $E_{\rm xx}$  converges to within  $\approx 10^{-2}\% - 10^{-3}\%$  of PWSCF (ACE) (i.e., the *a priori* estimated level of accuracy in SeA for  $10^{-3.0} \ge \varepsilon \ge 10^{-4.0}$ ; see Figure 3 and Table 1) and no appreciable oscillatory behavior was observed in the total energy during the EXX-SCF procedure. We empirically found that this convergence criterion requires essentially the same number of outer-loop steps when compared to the default convergence criteria in PWSCF (ACE) for these aqueous systems. While further tightening of this convergence criterion has a negligible effect on  $E_{xx}$  (i.e.,  $\approx 10^{-4}$ %, which is smaller than the *a priori* estimated accuracy of SEA), the use of a significantly tighter convergence criterion (e.g.,  $\approx 10^{-12}$ ) will ultimately lead to oscillations in  $E_{xx}$  (and the total energy) with a magnitude of  $\approx 10^{-4}$ %.

#### APPENDIX C: COMPUTATIONAL DETAILS (ELECTRONIC STRUCTURE CALCULATIONS)

For all hybrid DFT calculations (with SeA or PWSCF-(ACE)), we used an in-house implementation built upon the PWSCF module of Quantum ESPRESSO (git version: qe-7.0, in which the vexx function in PWSCF (ACE) can effectively exploit both MPI and OpenMP parallelization). We modeled the interactions between the valence electrons and ions (nuclei and their frozen-core electrons) using the Hamann-Schlüter-Chiang-Vanderbilt (HSCV) type norm-conserving pseudopotentials<sup>95,96</sup> distributed with the Qbox package.<sup>97</sup> Pseudowave functions for the valence electrons were represented using a planewave basis truncated at a maximum kinetic energy of 85 Ry. Unless otherwise specified, default settings (e.g., Davidson diagonalization, convergence thresholds, and density mixing parameters) were used throughout. For all PWSCF (ACE) calculations, the integrable divergence at G = 0 during vexx evaluations was treated using the Gygi-Baldereschi approach<sup>20</sup> in conjunction with the finite-size correction proposed by Nguyen and de Gironcoli (i.e., x gamma extrapolation).<sup>80</sup> For all SeA calculations, we solved the near-field PE using an  $O(h^{12})$  discrete Laplacian operator and a final residual of 10<sup>-3</sup> Bohr<sup>-3</sup> in the conjugate gradient (CG) solver; each far-field ME was computed with a maximum angular momentum of  $l_{max} = 6$ .

#### APPENDIX D: COMPUTATIONAL DETAILS (DNN TRAINING AND DPMD SIMULATIONS)

The DeepMD-kit<sup>98</sup> (git version: v1.3.3) interfaced with the TensorFlow library<sup>99</sup> (git version: v2.4.0) was used to train the DNN model for liquid water based on the total energy E and ionic forces  $\{F_I\}$  from each selected configuration in the training set. We used DeepPot-SE<sup>84</sup> to smoothly map the local chemical environment around each atom (i.e., the relative atomic coordinates within a radius of 6 Å) into input for a DNN model containing two coupled three-layer DNNs (i.e., an embedding network with (25, 50, 100) neurons and a fitting network with (60, 60, 60) neurons). During the training/ active-learning process, we followed refs 83 and 84 and minimized the following loss function  $\mathcal{L}$ :

$$\mathcal{L}(\lambda, \eta) = \frac{\lambda}{N^2} |\Delta E|^2 + \frac{\eta}{3N} \sum_{I} |\Delta F_I|^2$$
(D1)

in which  $\Delta E$  and  $\Delta F_I$  are the differences between the DPMD model prediction and the training data for E and  $F_I$ , respectively, and N is the number of atoms in a given configuration. The Adam stochastic gradient descent method<sup>100</sup> was performed for 0.5 M steps to train the DPMD model parameters ( $\lambda$  and  $\eta$ ) with an initial learning rate of  $5.0 \times 10^{-3}$ that exponentially decayed with respect to the number of training steps to  $1.0 \times 10^{-8}$ . As a function of the learning rate, we linearly varied  $\lambda$  (from  $10^{-2}$  to 1) and  $\eta$  (from  $10^3$  to 1) to achieve an efficient and well-balanced training procedure.

All DPMD simulations were performed using LAMMPS<sup>101</sup> (git version: stable\_29Oct2020) with Nosé–Hoover thermostat and barostat chains<sup>102</sup> (with chain lengths of 3 and characteristic time scales of 0.1 and 0.5 ps, respectively). All hydrogen atoms were replaced with deuterium to allow for a 0.5 fs integration time step. For each temperature setting, we performed a 100 ps equilibration run followed by a 1 ns production calculation to sample the *NpT* ensemble using a cubic periodic cell with 64 water molecules. Snapshots were taken every 100 DPMD steps to form a discrete trajectory for analysis.

#### AUTHOR INFORMATION

#### Corresponding Author

Robert A. DiStasio, Jr. – Department of Chemistry and Chemical Biology, Cornell University, Ithaca, New York 14853, United States; © orcid.org/0000-0003-2732-194X; Email: distasio@cornell.edu

#### Authors

- Hsin-Yu Ko Department of Chemistry and Chemical Biology, Cornell University, Ithaca, New York 14853, United States; Ocrid.org/0000-0003-1619-6514
- Marcos F. Calegari Andrade Department of Chemistry, Princeton University, Princeton, New Jersey 08544, United States; Quantum Simulations Group, Materials Science Division, Lawrence Livermore National Laboratory, Livermore, California 94550, United States; orcid.org/ 0000-0001-8630-7393
- Zachary M. Sparrow Department of Chemistry and Chemical Biology, Cornell University, Ithaca, New York 14853, United States; ocid.org/0000-0001-6163-2843
- Ju-an Zhang Department of Chemistry and Chemical Biology, Cornell University, Ithaca, New York 14853, United States; Orcid.org/0009-0006-9728-7176

Complete contact information is available at: https://pubs.acs.org/10.1021/acs.jctc.2c00827

#### Notes

The authors declare no competing financial interest.

<span id="page-17-0"></span><span id="page-17-0"></span>

## <span id="page-17-0"></span> ACKNOWLEDGMENTS

All authors thank Anil Damle for helpful scientific discussions. This work was supported as part of the Center for Alkaline Based Energy Solutions (CABES), an Energy Frontier Research Center funded by the U.S. Department of Energy, Office of Science, Basic Energy Sciences at Cornell University under Award No. DE-SC0019445. In addition, R.A.D. also gratefully acknowledges financial support from an Alfred P. Sloan Research Fellowship. M.F.C.A. acknowledges financial support from Lawrence Livermore National Lab (LLNL). The work at LLNL was performed under the auspices of the U.S. Department of Energy under Contract No. DE-AC52- 07NA27344. This research used resources of the National Energy Research Scientific Computing Center, which is supported by the Office of Science of the U.S. Department of Energy under Contract No. DE-AC02-05CH11231.

## REFERENCES
References were removed from this document. Please see the full publication for details.
